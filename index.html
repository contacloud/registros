<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contacloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'], // Usar Inter como fuente principal
                    },
                    colors: {
                        // Colores de fondo inspirados en la última imagen (azul oscuro/morado)
                        'gradient-main-start': '#2a2a4a', /* Azul oscuro */
                        'gradient-main-end': '#4a2a4a', /* Morado oscuro */
                         // Definir colores para los degradados de elementos (mantener un contraste)
                         'gradient-element-start': '#6a4a8a', /* Tono morado */
                         'gradient-element-end': '#8a6a4a', /* Tono dorado/naranja */
                         'gradient-element-hover-start': '#5a3a7a',
                         'gradient-element-hover-end': '#7a5a3a',
                         // Colores para el menú lateral (fondo oscuro, texto blanco)
                         'sidebar-bg': '#1a1a3a', /* Azul muy oscuro para la barra lateral */
                         'sidebar-link': '#ffffff', /* Blanco para enlaces */
                         'sidebar-link-hover': '#e0e0e0', /* Gris claro al pasar el ratón */
                         'sidebar-active': '#4a2a4a', /* Morado oscuro para activo */
                    }
                }
            }
        }
    </script>
    <style>
        /* Estilos Generales y Degradado */
        body {
            font-family: 'Inter', sans-serif;
            /* Aplicar el degradado de fondo de la última imagen */
            background: linear-gradient(to right, var(--tw-gradient-main-start) 0%, var(--tw-gradient-main-end) 100%);
            --tw-gradient-main-start: #2a2a4a; /* Azul oscuro */
            --tw-gradient-main-end: #4a2a4a; /* Morado oscuro */
            color: #333;
            line-height: 1.6;
            min-height: 100vh; /* Asegura que el degradado cubra toda la altura */
            box-sizing: border-box;
            display: flex; /* Usar flexbox para el layout principal */
        }
         /* Estilos del Menú Lateral */
        .sidebar {
            width: 200px; /* Ancho del menú lateral */
            background-color: var(--tw-sidebar-bg);
            color: var(--tw-sidebar-link);
            padding: 20px;
            display: flex;
            flex-direction: column;
            border-radius: 0 20px 20px 0; /* Bordes redondeados solo a la derecha */
            box-shadow: 4px 0 10px rgba(0, 0, 0, 0.3); /* Sombra más pronunciada */
             flex-shrink: 0; /* Evita que se encoja */
        }
        .sidebar h2 {
            color: white;
            font-size: 1.6rem;
            font-weight: bold;
            margin-bottom: 30px;
            text-align: center;
        }
        .sidebar-nav-link {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: 10px;
            color: white !important; /* Texto siempre blanco */
            text-decoration: none;
            transition: all 0.3s ease;
            font-size: 1rem;
        }
        .sidebar-nav-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white !important; /* Color al pasar el ratón (blanco) */
        }
        .sidebar-nav-link.active {
            background-color: var(--tw-sidebar-active);
            color: white !important; /* Texto blanco para activo */
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3); /* Sombra más pronunciada */
        }
        .sidebar-nav-link i {
            margin-right: 10px; /* Espacio para iconos si se usan */
        }

         /* Contenido Principal */
        .main-content {
            flex-grow: 1; /* Ocupar el espacio restante */
            padding: 20px;
            overflow-y: auto; /* Permitir scroll si el contenido es largo */
        }

        .container {
            max-width: 1200px;
            margin: 0 auto; /* Centrar el contenido dentro del main-content */
            padding: 30px;
            background-color: rgba(255, 255, 255, 0.1); /* Fondo con baja opacidad para ver el fondo */
            border-radius: 30px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5); /* Sombra más pronunciada */
            backdrop-filter: blur(8px); /* Desenfoque */
             color: #eee; /* Texto claro para contrastar con el fondo oscuro */
        }
        .container h2, .container h3, .container h4 {
            color: white; /* Asegurar que los títulos sean blancos */
        }
         .container label {
             color: #ccc; /* Color para las etiquetas */
         }

        .tab-content {
            display: none;
            padding-top: 0;
        }
        .tab-content.active {
            display: block;
        }
        .card {
            background-color: rgba(255, 255, 255, 0.15); /* Fondo de tarjeta con opacidad */
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
             backdrop-filter: blur(5px); /* Ligero desenfoque en las tarjetas */
             color: #eee; /* Texto claro dentro de las tarjetas */
        }
         .card h3, .card h4 {
             color: white; /* Asegurar que los títulos de las tarjetas sean blancos */
         }

        .input-field {
            padding: 16px;
            border: 1px solid rgba(255, 255, 255, 0.3); /* Borde con opacidad */
            background-color: rgba(255, 255, 255, 0.1); /* Fondo con opacidad */
            color: white; /* Texto blanco */
            border-radius: 12px;
            margin-bottom: 15px;
            width: 100%;
            box-sizing: border-box;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
         .input-field::placeholder {
             color: rgba(255, 255, 255, 0.6); /* Color del placeholder con opacidad */
         }
        .input-field:focus {
            outline: none;
            border-color: rgba(0, 123, 255, 0.6); /* Borde azul al enfocar con opacidad */
            box-shadow: 0 0 8px rgba(0, 123, 255, 0.6);
            background-color: rgba(255, 255, 255, 0.2); /* Fondo más claro al enfocar */
        }

        /* Estilo para el texto en los selectores cuando están desplegados */
        .input-field option {
            color: #333; /* Texto negro para las opciones del select */
        }

        .btn {
            padding: 16px 28px;
            background: linear-gradient(to right, var(--tw-gradient-element-start) 0%, var(--tw-gradient-element-end) 100%);
             --tw-gradient-element-start: #6a4a8a; /* Tono morado */
             --tw-gradient-element-end: #8a6a4a; /* Tono dorado/naranja */
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: medium;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.4);
        }
        .btn:hover {
            --tw-gradient-element-start: #5a3a7a;
            --tw-gradient-element-end: #7a5a3a;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);
        }
        .btn:active {
            --tw-gradient-element-start: #4a2a6a;
            --tw-gradient-element-end: #6a4a2a;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.6);
        }
         .btn-sm {
             padding: 10px 16px;
             font-size: 0.9rem;
         }
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 44px 8px rgba(0, 0, 0, 0.2);
        }
        .table th, .table td {
            border: 1px solid rgba(255, 255, 255, 0.2); /* Borde con opacidad */
            padding: 15px;
            text-align: left;
             color: #eee; /* Texto claro en la tabla */
        }
         .table th {
            background-color: rgba(242, 242, 242, 0.1); /* Fondo de encabezado con opacidad */
            font-weight: medium;
             color: white; /* Texto blanco en encabezados */
        }
         .table td[contenteditable="true"] {
             background-color: rgba(238, 238, 255, 0.1); /* Ligero fondo con opacidad */
             cursor: text;
             transition: background-color 0.2s ease;
         }
          .table td[contenteditable="true"]:focus {
             outline: none;
             background-color: rgba(221, 221, 255, 0.2); /* Fondo más visible al enfocar */
          }

        .table tr:nth-child(even) {
            background-color: rgba(249, 249, 249, 0.05); /* Rayado para filas con opacidad muy baja */
        }
         /* Estilos para la vista de detalle de cliente */
        #detalle-cliente-view {
            display: none;
            padding: 30px;
            background-color: rgba(255, 255, 255, 0.1); /* Fondo con opacidad */
            border-radius: 30px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            margin: 20px auto;
            max-width: 1200px;
             color: #eee; /* Texto claro */
        }
         #detalle-cliente-view h2 {
            background: linear-gradient(to right, var(--tw-gradient-element-start) 0%, var(--tw-gradient-element-end) 100%);
            --tw-gradient-element-start: #6a4a8a; /* Tono morado */
            --tw-gradient-element-end: #8a6a4a; /* Tono dorado/naranja */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: bold;
         }
         #detalle-cliente-view label {
             color: #ccc; /* Color para las etiquetas */
         }
         #detalle-cliente-view .text-gray-700 { /* Ajustar color de texto para RFC */
             color: #ccc;
         }


         .dashboard-placeholder {
            height: 300px;
            background: linear-gradient(to right, rgba(106, 74, 138, 0.3), rgba(138, 106, 74, 0.3)); /* Degradado suave con opacidad */
            border-radius: 18px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #ccc; /* Texto claro */
            font-size: 1.5rem;
            margin-bottom: 30px;
            box-shadow: inset 0 3px 6px rgba(0, 0, 0, 0.2); /* Sombra interior */
         }
          .dashboard-placeholder p {
              color: #bbb; /* Texto más claro dentro del placeholder */
          }

         .modal {
             display: none;
             position: fixed;
             z-index: 100;
             left: 0;
             top: 0;
             width: 100%;
             height: 100%;
             overflow: auto;
             background-color: rgba(0,0,0,0.8); /* Fondo más oscuro */
             justify-content: center;
             align-items: center;
             animation: fadeIn 0.3s ease-out;
         }
         .modal-content {
             background-color: rgba(255, 255, 255, 0.95); /* Fondo casi opaco */
             margin: auto;
             padding: 30px;
             border: 1px solid rgba(136, 136, 136, 0.5); /* Borde con opacidad */
             width: 90%;
             max-width: 550px;
             border-radius: 20px;
             box-shadow: 0 10px 20px rgba(0,0,0,0.4);
             animation: slideIn 0.3s ease-out;
             color: #333; /* Texto oscuro dentro del modal */
         }
         .modal-content h3 {
             color: #333; /* Título oscuro dentro del modal */
         }
         .close-button {
             color: #aaa;
             float: right;
             font-size: 32px;
             font-weight: bold;
             transition: color 0.3s ease;
         }
         .close-button:hover,
         .close-button:focus {
             color: #000;
             text-decoration: none;
             cursor: pointer;
         }
         /* Animaciones */
         @keyframes fadeIn {
             from { opacity: 0; }
             to { opacity: 1; }
         }
         @keyframes slideIn {
             from { transform: translateY(-20px); opacity: 0; }
             to { transform: translateY(0); opacity: 1; }
         }

         /* Estilo para el nuevo elemento visual en Inicio */
        .inicio-visual-card {
            background: linear-gradient(to right, var(--tw-gradient-element-start) 0%, var(--tw-gradient-element-end) 100%);
            --tw-gradient-element-start: #6a4a8a; /* Tono morado */
            --tw-gradient-element-end: #8a6a4a; /* Tono dorado/naranja */
            color: white;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            font-size: 1.8rem;
            font-weight: bold;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
        }
         /* Estilos para el área de gráficos */
        #graficos .card {
            padding: 30px;
             /* Aplicar degradado al card de gráficos */
            background: linear-gradient(to bottom right, rgba(255, 255, 255, 0.15), rgba(240, 240, 255, 0.1)); /* Degradado con opacidad */
        }
        #graficos .chart-container {
            margin-bottom: 30px;
            background-color: rgba(249, 249, 249, 0.1); /* Fondo con opacidad */
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
         #graficos-area h3 {
             background: linear-gradient(to right, var(--tw-gradient-element-start) 0%, var(--tw-gradient-element-end) 100%);
            --tw-gradient-element-start: #6a4a8a; /* Tono morado */
            --tw-gradient-element-end: #8a6a4a; /* Tono dorado/naranja */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 1.8rem;
            font-weight: bold;
             color: white !important; /* Texto del mensaje personalizado siempre blanco */
         }
         /* Contenedor para limitar el tamaño del canvas del gráfico */
         .chart-canvas-container {
             position: relative; /* Necesario para que el canvas ocupe el 100% del contenedor */
             height: 300px; /* Altura fija para limitar el tamaño del gráfico */
             width: 100%; /* Ancho completo del contenedor */
         }
         .chart-canvas-container canvas {
             display: block; /* Evita espacio extra debajo del canvas */
             width: 100% !important; /* Asegura que Chart.js use el 100% del ancho del contenedor */
             height: 100% !important; /* Asegura que Chart.js use el 100% de la altura del contenedor */
         }
         /* Estilos para la leyenda de la gráfica de pastel */
         .pie-chart-legend {
             display: flex;
             flex-direction: column;
             align-items: flex-start;
             margin-left: 20px;
             color: #eee; /* Texto claro para la leyenda */
         }
         .pie-chart-legend-item {
             display: flex;
             align-items: center;
             margin-bottom: 5px;
         }
         .pie-chart-legend-color {
             width: 15px;
             height: 15px;
             border-radius: 3px;
             margin-right: 10px;
         }
    </style>
</head>
<body>

<div class="sidebar">
    <h2>Contacloud</h2>
    <a href="#" class="sidebar-nav-link active" onclick="openTab(event, 'inicio')">
        Inicio
    </a>
    <a href="#" class="sidebar-nav-link" onclick="openTab(event, 'clientes')">
         Clientes
    </a>
     <a href="#" class="sidebar-nav-link" onclick="openTab(event, 'graficos')">
        Gráficos
    </a>
    </div>

<div class="main-content">
    <div class="container">
        <div id="inicio" class="tab-content active">
            <h2 class="text-2xl font-semibold mb-6">Resumen General</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                 <div class="inicio-visual-card col-span-1 md:col-span-2">
                     ¡Bienvenido a Contacloud!
                     <p class="text-lg font-normal mt-2">Controla tus declaraciones y pagos pendientes de un vistazo.</p>
                 </div>
                <div class="card">
                    <h3 class="text-xl font-medium mb-4">Declaraciones Pendientes</h3>
                    <ul id="lista-pendientes">
                        </ul>
                </div>
                <div class="card">
                    <h3 class="text-xl font-medium mb-4">Pagos Pendientes</h3>
                    <ul id="lista-pagos">
                        </ul>
                </div>
            </div>
        </div>

        <div id="clientes" class="tab-content">
            <h2 class="text-2xl font-semibold mb-6">Gestión de Clientes</h2>
            <div class="mb-6 flex flex-col md:flex-row gap-4">
                <input type="text" id="nombre-cliente" class="input-field flex-grow" placeholder="Nombre del Cliente">
                <input type="text" id="rfc-cliente" class="input-field flex-grow" placeholder="RFC">
                <button class="btn" onclick="agregarCliente()">Agregar Cliente</button>
            </div>
            <div id="lista-clientes" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                </div>
        </div>

        <div id="graficos" class="tab-content">
            <h2 class="text-2xl font-semibold mb-6">Gráficos de Clientes</h2>
            <div class="card">
                <div class="mb-6">
                    <label for="cliente-selector-graficos" class="mr-4 text-lg font-medium">Seleccionar Cliente:</label>
                    <select id="cliente-selector-graficos" class="input-field w-auto inline-block" onchange="mostrarGraficosCliente()">
                        <option value="">-- Selecciona un cliente --</option>
                        </select>
                </div>
                <div id="graficos-area" style="display: none;">
                    <h3 id="mensaje-personalizado-graficos" class="text-xl font-semibold mb-6"></h3>

                    <div class="chart-container">
                        <h4 class="text-lg font-medium mb-4">Resumen Anual (Evolución Mensual)</h4>
                        <div class="chart-canvas-container">
                            <canvas id="graficoAnual"></canvas>
                        </div>
                         <div class="mt-4 text-sm text-gray-700">
                            <p>Nota: Este gráfico muestra la evolución mensual de Ingresos, Gastos e Impuestos para el año actual.</p>
                         </div>
                    </div>

                    <div class="chart-container">
                        <h4 class="text-lg font-medium mb-4">Gráfica Mensual (Ingresos, Gastos, Impuestos)</h4>
                         <div class="mb-4 flex items-center gap-4">
                             <label for="month-selector-pie">Mes:</label>
                             <select id="month-selector-pie" class="input-field w-auto inline-block">
                                 <option value="Enero">Enero</option>
                                 <option value="Febrero">Febrero</option>
                                 <option value="Marzo">Marzo</option>
                                 <option value="Abril">Abril</option>
                                 <option value="Mayo">Mayo</option>
                                 <option value="Junio">Junio</option>
                                 <option value="Julio">Julio</option>
                                 <option value="Agosto">Agosto</option>
                                 <option value="Septiembre">Septiembre</option>
                                 <option value="Octubre">Octubre</option>
                                 <option value="Noviembre">Noviembre</option>
                                 <option value="Diciembre">Diciembre</option>
                             </select>
                             <label for="year-selector-pie">Año:</label>
                             <select id="year-selector-pie" class="input-field w-auto inline-block">
                                 </select>
                              <button class="btn btn-sm" onclick="updateMonthlyPieChart()">Mostrar Gráfica</button>
                         </div>
                         <div class="flex flex-col md:flex-row items-center">
                            <div class="chart-canvas-container flex-grow">
                                <canvas id="graficoMensualPie"></canvas>
                            </div>
                             <div id="pie-chart-legend" class="pie-chart-legend mt-4 md:mt-0">
                                 </div>
                         </div>

                         <div class="mt-4 text-sm text-gray-700">
                            <p>Nota: Selecciona un mes y año para ver el desglose de Ingresos, Gastos e Impuestos en la gráfica de pastel.</p>
                         </div>
                    </div>
                     </div>
                 <div id="no-cliente-selected" class="text-center text-gray-600 text-lg mt-8">
                     Selecciona un cliente para ver sus gráficos.
                 </div>
            </div>
        </div>

    </div>
</div>


<div id="detalle-cliente-view" class="container">
    <button class="btn mb-6" onclick="cerrarDetalleCliente()">← Volver a Clientes</button>
    <h2 id="nombre-cliente-detalle"></h2>
     <p class="text-lg text-gray-700 mb-6">RFC: <span id="rfc-cliente-detalle"></span></p>

     <button class="btn btn-sm mb-6" onclick="abrirModalEditarCliente()">Editar Cliente</button>

    <div class="card">
         <h3 class="text-xl font-medium mb-4">Resumen Financiero Anual</h3>
         <div class="dashboard-placeholder mb-6">
             Espacio para Gráficos y Dashboards
             <p class="text-sm text-gray-600 mt-2">Aquí se mostrarían gráficos de ingresos, gastos, impuestos por mes o año.</p>
         </div>
         <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center font-bold text-xl text-gray-800">
             <div>Ingresos Anuales: $<span id="total-ingresos-cliente">0</span></div>
             <div>Gastos Anuales: $<span id="total-gastos-cliente">0</span></div>
             <div>Impuestos Anuales: $<span id="total-impuestos-cliente">0</span></div>
         </div>
    </div>


     <div class="card">
         <h3 class="text-xl font-medium mb-4">Datos Mensuales</h3>
          <div class="mb-4">
             <label for="year-selector-data" class="mr-2">Año:</label>
             <select id="year-selector-data" class="input-field w-auto inline-block" onchange="mostrarDatosClientePorAño()">
                 </select>
         </div>
         <table class="table">
             <thead>
                 <tr>
                     <th>Mes</th>
                     <th>Ingresos</th>
                     <th>Gastos</th>
                     <th>Impuestos</th>
                 </tr>
             </thead>
             <tbody id="tabla-datos-mensuales">
                 </tbody>
         </table>
         </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
         <div class="card">
             <h3 class="text-xl font-medium mb-4">Declaraciones Mensuales <span id="declaraciones-year-title"></span></h3>
              <div class="mb-4">
                 <label for="year-selector-declaraciones" class="mr-2">Año:</label>
                 <select id="year-selector-declaraciones" class="input-field w-auto inline-block" onchange="mostrarDatosClientePorAño()">
                     </select>
             </div>
             <table class="table">
                 <thead>
                     <tr>
                         <th>Mes</th>
                         <th>Completada</th>
                     </tr>
                 </thead>
                 <tbody id="tabla-declaraciones-mensuales">
                     </tbody>
             </table>
         </div>
         <div class="card">
             <h3 class="text-xl font-medium mb-4">Estado de Pago Mensual <span id="pagos-year-title"></span></h3>
              <div class="mb-4">
                 <label for="year-selector-pagos" class="mr-2">Año:</label>
                 <select id="year-selector-pagos" class="input-field w-auto inline-block" onchange="mostrarDatosClientePorAño()">
                     </select>
             </div>
              <table class="table">
                 <thead>
                     <tr>
                         <th>Mes</th>
                         <th>Pagado</th>
                     </tr>
                 </thead>
                 <tbody id="tabla-pagos-mensuales">
                     </tbody>
             </table>
         </div>
    </div>


</div>

<div id="modalEditarCliente" class="modal">
  <div class="modal-content">
    <span class="close-button" onclick="cerrarModalEditarCliente()">&times;</span>
    <h3 class="text-xl font-semibold mb-4">Editar Cliente</h3>
    <input type="text" id="edit-nombre-cliente" class="input-field" placeholder="Nombre del Cliente">
    <input type="text" id="edit-rfc-cliente" class="input-field" placeholder="RFC">
    <button class="btn mt-4" onclick="guardarEdicionCliente()">Guardar Cambios</button>
  </div>
</div>


<script>
    // Datos de ejemplo (se pueden cargar desde localStorage o un backend)
    let clientes = [];
    const meses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
    const añoActual = new Date().getFullYear();

    // Variables para gráficos
    let graficoAnualChart = null;
    let graficoMensualPieChart = null;


    // Función para cambiar entre la vista principal (pestañas) y la vista de detalle de cliente
    function mostrarVista(vistaId) {
        const mainContent = document.querySelector('.main-content');
        const detalleClienteView = document.getElementById('detalle-cliente-view');

        if (vistaId === 'main') {
            mainContent.style.display = 'block';
            detalleClienteView.style.display = 'none';
        } else if (vistaId === 'detalle-cliente') {
            mainContent.style.display = 'none';
            detalleClienteView.style.display = 'block';
        }
    }


    // Función para cambiar de pestaña en el menú lateral
    function openTab(event, tabId) {
         // Asegurarse de estar en la vista principal
         mostrarVista('main');

        // Ocultar todos los contenidos de las pestañas
        const tabContents = document.querySelectorAll('.tab-content');
        tabContents.forEach(content => {
            content.classList.remove('active');
        });

        // Quitar la clase 'active' de todos los enlaces del menú lateral
        const navLinks = document.querySelectorAll('.sidebar-nav-link');
        navLinks.forEach(link => {
            link.classList.remove('active');
        });

        // Mostrar el contenido de la pestaña seleccionada
        document.getElementById(tabId).classList.add('active');

        // Añadir la clase 'active' al enlace del menú lateral seleccionado
        if (event) { // event es null cuando se llama desde DOMContentLoaded
             event.currentTarget.classList.add('active');
        } else {
             // Activar el primer enlace si se llama desde DOMContentLoaded
             document.querySelector('.sidebar-nav-link').classList.add('active');
        }


        // Si cambiamos a la pestaña de inicio, actualizar el resumen
        if (tabId === 'inicio') {
            actualizarResumenInicio();
        }
         // Si cambiamos a la pestaña de clientes, listar los clientes
         if (tabId === 'clientes') {
            listarClientes();
        }
         // Si cambiamos a la pestaña de gráficos, cargar los clientes en el selector
         if (tabId === 'graficos') {
             cargarClientesEnSelectorGraficos();
             // Ocultar el área de gráficos hasta que se seleccione un cliente
             document.getElementById('graficos-area').style.display = 'none';
             document.getElementById('no-cliente-selected').style.display = 'block';
         }
    }

    // --- Funcionalidad de Clientes (en la vista principal) ---
    function agregarCliente() {
        const nombreInput = document.getElementById('nombre-cliente');
        const rfcInput = document.getElementById('rfc-cliente');
        const nombre = nombreInput.value.trim();
        const rfc = rfcInput.value.trim();

        if (nombre && rfc) {
             // Inicializar datos para el año actual
             const datosMensualesIniciales = meses.map(mes => ({ mes: mes, ingresos: 0, gastos: 0, impuestos: 0 }));
             const declaracionesMensualesIniciales = meses.map(mes => ({ mes: mes, completada: false }));
             const pagosMensualesIniciales = meses.map(mes => ({ mes: mes, pagado: false }));


            clientes.push({
                id: Date.now(), // ID único simple
                nombre: nombre,
                rfc: rfc,
                // Almacenar datos, declaraciones y pagos por año
                datosPorAño: { [añoActual]: datosMensualesIniciales },
                declaracionesPorAño: { [añoActual]: declaracionesMensualesIniciales },
                pagosPorAño: { [añoActual]: pagosMensualesIniciales }
            });
            nombreInput.value = '';
            rfcInput.value = '';
            listarClientes();
            guardarDatos(); // Guardar después de agregar
        } else {
            alert('Por favor, completa el nombre y RFC del cliente.');
        }
    }

    function listarClientes() {
        const listaClientesDiv = document.getElementById('lista-clientes');
        listaClientesDiv.innerHTML = ''; // Limpiar lista actual
        clientes.forEach(cliente => {
            const clienteElement = document.createElement('div');
            clienteElement.classList.add('card', 'cursor-pointer');
            clienteElement.innerHTML = `
                <p class="font-semibold">${cliente.nombre}</p>
                <p class="text-sm text-gray-600">RFC: ${cliente.rfc}</p>
            `;
            clienteElement.onclick = () => mostrarDetalleCliente(cliente.id); // Pasar el ID del cliente
            listaClientesDiv.appendChild(clienteElement);
        });
    }

     // --- Funcionalidad de Detalle de Cliente (en la nueva vista) ---
     let clienteActualId = null; // Para saber qué cliente estamos viendo
     let añoSeleccionado = añoActual; // Año por defecto

    function mostrarDetalleCliente(clienteId) {
        const cliente = clientes.find(c => c.id === clienteId);
        if (!cliente) return; // Salir si no se encuentra el cliente

        clienteActualId = clienteId; // Guardar el ID del cliente actual
        añoSeleccionado = añoActual; // Resetear al año actual al abrir detalle

        document.getElementById('nombre-cliente-detalle').textContent = cliente.nombre;
        document.getElementById('rfc-cliente-detalle').textContent = cliente.rfc;

        // Cargar opciones en los selectores de año
        cargarSelectoresAño();

        // Mostrar datos para el año seleccionado
        mostrarDatosClientePorAño();

        // Cambiar a la vista de detalle de cliente
        mostrarVista('detalle-cliente');
    }

    function cargarSelectoresAño() {
        const yearSelectors = document.querySelectorAll('#detalle-cliente-view select[id^="year-selector"]');
        const añosDisponibles = new Set();

        // Obtener todos los años con datos para este cliente
        const cliente = clientes.find(c => c.id === clienteActualId);
        if (cliente) {
            Object.keys(cliente.datosPorAño).forEach(año => añosDisponibles.add(parseInt(año)));
            Object.keys(cliente.declaracionesPorAño).forEach(año => añosDisponibles.add(parseInt(año)));
            Object.keys(cliente.pagosPorAño).forEach(año => añosDisponibles.add(parseInt(año)));
        }

        // Añadir el año actual si no está presente
        añosDisponibles.add(añoActual);

        const añosOrdenados = Array.from(añosDisponibles).sort((a, b) => b - a); // Ordenar de más reciente a más antiguo

        yearSelectors.forEach(selector => {
            selector.innerHTML = ''; // Limpiar opciones actuales
            añosOrdenados.forEach(año => {
                const option = document.createElement('option');
                option.value = año;
                option.textContent = año;
                selector.appendChild(option);
            });
            // Seleccionar el año actual por defecto
            selector.value = añoSeleccionado;
        });
    }

    function mostrarDatosClientePorAño() {
        const cliente = clientes.find(c => c.id === clienteActualId);
        if (!cliente) return;

        // Obtener el año seleccionado de cualquiera de los selectores (deberían estar sincronizados)
        añoSeleccionado = parseInt(document.getElementById('year-selector-data').value);

        // Obtener datos, declaraciones y pagos para el año seleccionado
        const datosMensualesAño = cliente.datosPorAño[añoSeleccionado] || meses.map(mes => ({ mes: mes, ingresos: 0, gastos: 0, impuestos: 0 }));
        const declaracionesMensualesAño = cliente.declaracionesPorAño[añoSeleccionado] || meses.map(mes => ({ mes: mes, completada: false }));
        const pagosMensualesAño = cliente.pagosPorAño[añoSeleccionado] || meses.map(mes => ({ mes: mes, pagado: false }));

        // Mostrar datos mensuales en la tabla (celdas editables)
        const tablaDatosMensualesBody = document.getElementById('tabla-datos-mensuales');
        tablaDatosMensualesBody.innerHTML = ''; // Limpiar tabla actual
        let totalIngresos = 0;
        let totalGastos = 0;
        let totalImpuestos = 0;

        datosMensualesAño.forEach(dato => {
            const row = tablaDatosMensualesBody.insertRow();
            row.innerHTML = `
                <td>${dato.mes}</td>
                <td contenteditable="true" data-mes="${dato.mes}" data-tipo="ingresos">${dato.ingresos.toFixed(2)}</td>
                <td contenteditable="true" data-mes="${dato.mes}" data-tipo="gastos">${dato.gastos.toFixed(2)}</td>
                <td contenteditable="true" data-mes="${dato.mes}" data-tipo="impuestos">${dato.impuestos.toFixed(2)}</td>
            `;
             totalIngresos += dato.ingresos;
             totalGastos += dato.gastos;
             totalImpuestos += dato.impuestos;
        });

         // Añadir event listeners a las celdas editables
         tablaDatosMensualesBody.querySelectorAll('td[contenteditable="true"]').forEach(cell => {
             cell.addEventListener('blur', handleMonthlyDataEdit); // Usar 'blur' para guardar cuando se sale de la celda
             cell.addEventListener('keypress', function(event) {
                 if (event.key === 'Enter') {
                     event.preventDefault(); // Prevenir salto de línea
                     cell.blur(); // Simular blur para guardar
                 }
             });
         });


         // Actualizar resumen financiero anual
         document.getElementById('total-ingresos-cliente').textContent = totalIngresos.toFixed(2);
         document.getElementById('total-gastos-cliente').textContent = totalGastos.toFixed(2);
         document.getElementById('total-impuestos-cliente').textContent = totalImpuestos.toFixed(2);


        // Mostrar estado de declaraciones mensuales
        document.getElementById('declaraciones-year-title').textContent = `(${añoSeleccionado})`;
        const tablaDeclaracionesMensualesBody = document.getElementById('tabla-declaraciones-mensuales');
        tablaDeclaracionesMensualesBody.innerHTML = ''; // Limpiar tabla actual
        declaracionesMensualesAño.forEach(declaracion => {
            const row = tablaDeclaracionesMensualesBody.insertRow();
            row.innerHTML = `
                <td>${declaracion.mes}</td>
                <td>
                    <input type="checkbox" ${declaracion.completada ? 'checked' : ''} onchange="marcarDeclaracionMensual('${declaracion.mes}', this.checked)">
                </td>
            `;
        });

        // Mostrar estado de pago mensual
        document.getElementById('pagos-year-title').textContent = `(${añoSeleccionado})`;
        const tablaPagosMensualesBody = document.getElementById('tabla-pagos-mensuales');
        tablaPagosMensualesBody.innerHTML = ''; // Limpiar tabla actual
        pagosMensualesAño.forEach(pago => {
            const row = tablaPagosMensualesBody.insertRow();
            row.innerHTML = `
                <td>${pago.mes}</td>
                <td>
                    <input type="checkbox" ${pago.pagado ? 'checked' : ''} onchange="marcarPagoMensual('${pago.mes}', this.checked)">
                </td>
            `;
        });

         // Sincronizar los selectores de año
         const yearSelectors = document.querySelectorAll('#detalle-cliente-view select[id^="year-selector"]');
         yearSelectors.forEach(selector => {
             selector.value = añoSeleccionado;
         });
    }

    // Función para manejar la edición directa en la tabla de datos mensuales
    function handleMonthlyDataEdit(event) {
        const cell = event.target;
        const mes = cell.dataset.mes;
        const tipo = cell.dataset.tipo; // 'ingresos', 'gastos', 'impuestos'
        let valor = parseFloat(cell.textContent) || 0; // Convertir a número, default 0 si no es válido

        // Opcional: Formatear el valor mostrado después de la edición
        cell.textContent = valor.toFixed(2);

        const cliente = clientes.find(c => c.id === clienteActualId);
        if (!cliente) return;

        const añoSeleccionadoDatos = parseInt(document.getElementById('year-selector-data').value);

        // Asegurar que el objeto para el año seleccionado exista
        if (!cliente.datosPorAño[añoSeleccionadoDatos]) {
             cliente.datosPorAño[añoSeleccionadoDatos] = meses.map(mes => ({ mes: mes, ingresos: 0, gastos: 0, impuestos: 0 }));
         }

        // Encontrar y actualizar el dato mensual para el año y mes correctos
        const datoMes = cliente.datosPorAño[añoSeleccionadoDatos].find(d => d.mes === mes);
        if (datoMes) {
            datoMes[tipo] = valor; // Actualizar la propiedad correcta (ingresos, gastos o impuestos)
        } else {
             // Esto no debería ocurrir si inicializamos todos los meses, pero como fallback
             console.error(`Dato para el mes ${mes} no encontrado para el año ${añoSeleccionadoDatos}`);
             return;
        }

        // Actualizar el resumen financiero anual en la vista de detalle
        let totalIngresos = 0;
        let totalGastos = 0;
        let totalImpuestos = 0;
         cliente.datosPorAño[añoSeleccionadoDatos].forEach(dato => {
             totalIngresos += dato.ingresos;
             totalGastos += dato.gastos;
             totalImpuestos += dato.impuestos;
         });
         document.getElementById('total-ingresos-cliente').textContent = totalIngresos.toFixed(2);
         document.getElementById('total-gastos-cliente').textContent = totalGastos.toFixed(2);
         document.getElementById('total-impuestos-cliente').textContent = totalImpuestos.toFixed(2);


        actualizarResumenInicio(); // Actualizar listas pendientes en inicio
        guardarDatos(); // Guardar después de modificar datos mensuales
    }


     function marcarDeclaracionMensual(mes, completada) {
         const cliente = clientes.find(c => c.id === clienteActualId);
         if (!cliente) return;

         const añoSeleccionadoDeclaraciones = parseInt(document.getElementById('year-selector-declaraciones').value); // Usar el selector de declaraciones

          // Asegurar que el objeto para el año seleccionado exista
         if (!cliente.declaracionesPorAño[añoSeleccionadoDeclaraciones]) {
             cliente.declaracionesPorAño[añoSeleccionadoDeclaraciones] = meses.map(mes => ({ mes: mes, completada: false }));
         }

         const declaracionMes = cliente.declaracionesPorAño[añoSeleccionadoDeclaraciones].find(d => d.mes === mes);
         if (declaracionMes) {
             declaracionMes.completada = completada;
             // No es necesario volver a mostrar el detalle, la UI se actualiza con el checkbox
             actualizarResumenInicio(); // Actualizar lista de pendientes en inicio
             guardarDatos(); // Guardar después de marcar declaración
         }
     }

     function marcarPagoMensual(mes, pagado) {
         const cliente = clientes.find(c => c.id === clienteActualId);
         if (!cliente) return;

         const añoSeleccionadoPagos = parseInt(document.getElementById('year-selector-pagos').value); // Usar el selector de pagos

         // Asegurar que el objeto para el año seleccionado exista
         if (!cliente.pagosPorAño[añoSeleccionadoPagos]) {
             cliente.pagosPorAño[añoSeleccionadoPagos] = meses.map(mes => ({ mes: mes, pagado: false }));
         }

         const pagoMes = cliente.pagosPorAño[añoSeleccionadoPagos].find(p => p.mes === mes);
         if (pagoMes) {
             pagoMes.pagado = pagado;
             // No es necesario volver a mostrar el detalle, la UI se actualiza con el checkbox
             actualizarResumenInicio(); // Actualizar lista de pagos en inicio
             guardarDatos(); // Guardar después de marcar pago
         }
     }


    function cerrarDetalleCliente() {
        clienteActualId = null; // Limpiar el cliente actual
        mostrarVista('main'); // Volver a la vista principal
        openTab(null, 'clientes'); // Mostrar la pestaña de clientes
    }

    // --- Funcionalidad de Edición de Cliente (Modal) ---
    function abrirModalEditarCliente() {
        const cliente = clientes.find(c => c.id === clienteActualId);
        if (!cliente) return;

        document.getElementById('edit-nombre-cliente').value = cliente.nombre;
        document.getElementById('edit-rfc-cliente').value = cliente.rfc;
        document.getElementById('modalEditarCliente').style.display = 'flex'; // Usar flex para centrar
    }

    function cerrarModalEditarCliente() {
        document.getElementById('modalEditarCliente').style.display = 'none';
    }

    function guardarEdicionCliente() {
        const cliente = clientes.find(c => c.id === clienteActualId);
        if (!cliente) return;

        const nuevoNombre = document.getElementById('edit-nombre-cliente').value.trim();
        const nuevoRfc = document.getElementById('edit-rfc-cliente').value.trim();

        if (nuevoNombre && nuevoRfc) {
            cliente.nombre = nuevoNombre;
            cliente.rfc = nuevoRfc;
            mostrarDetalleCliente(clienteActualId); // Actualizar la vista de detalle
            listarClientes(); // Actualizar la lista de clientes en la pestaña Clientes
            actualizarResumenInicio(); // Por si el nombre aparece en el resumen
            guardarDatos(); // Guardar después de editar cliente
            cerrarModalEditarCliente();
        } else {
            alert('El nombre y RFC no pueden estar vacíos.');
        }
    }

     // Cerrar modal si se hace clic fuera del contenido
     window.onclick = function(event) {
         const modal = document.getElementById('modalEditarCliente');
         if (event.target === modal) {
             cerrarModalEditarCliente();
         }
     }


    // --- Funcionalidad de Inicio/Resumen (actualizada con filtro por mes y año) ---
    function actualizarResumenInicio() {
        const hoy = new Date();
        const mesActualIndex = hoy.getMonth(); // 0 para Enero, 11 para Diciembre
        const añoActual = hoy.getFullYear();

        // Meses a revisar: de Enero del año actual hasta el mes anterior al actual
        const mesesARevisar = [];
        for (let i = 0; i < mesActualIndex; i++) {
            mesesARevisar.push(meses[i]);
        }

        // Actualizar lista de declaraciones pendientes (de todos los clientes, filtrado por mes y año)
        const listaPendientesUl = document.getElementById('lista-pendientes');
        listaPendientesUl.innerHTML = ''; // Limpiar lista actual

        const pendientesFiltradas = [];
        clientes.forEach(cliente => {
             // Obtener declaraciones del año actual
             const declaracionesAñoActual = cliente.declaracionesPorAño[añoActual] || [];
            declaracionesAñoActual.forEach(declaracion => {
                 const esMesARevisar = mesesARevisar.includes(declaracion.mes);
                if (!declaracion.completada && esMesARevisar) {
                    pendientesFiltradas.push(`${cliente.nombre} - Declaración ${declaracion.mes} ${añoActual}`);
                }
            });
        });

        if (pendientesFiltradas.length > 0) {
             pendientesFiltradas.forEach(pendiente => {
                const li = document.createElement('li');
                li.textContent = pendiente;
                li.classList.add('mb-1');
                listaPendientesUl.appendChild(li);
            });
        } else {
            listaPendientesUl.innerHTML = '<li>No hay declaraciones pendientes en los meses anteriores del año actual.</li>';
        }


        // Actualizar lista de pagos pendientes (de todos los clientes, filtrado por mes y año)
        const listaPagosUl = document.getElementById('lista-pagos');
        listaPagosUl.innerHTML = ''; // Limpiar lista actual

        const pagosPendientesFiltrados = [];
         clientes.forEach(cliente => {
             // Obtener pagos del año actual
             const pagosAñoActual = cliente.pagosPorAño[añoActual] || [];
            pagosAñoActual.forEach(pago => {
                 const esMesARevisar = mesesARevisar.includes(pago.mes);
                 if (!pago.pagado && esMesARevisar) {
                     pagosPendientesFiltrados.push(`${cliente.nombre} - Pago ${pago.mes} ${añoActual}`);
                 }
            });
         });


        if (pagosPendientesFiltrados.length > 0) {
            pagosPendientesFiltrados.forEach(pendiente => {
                const li = document.createElement('li');
                li.classList.add('flex', 'justify-between', 'items-center', 'mb-1');
                li.innerHTML = `
                    <span>${pendiente}</span>
                    `;
                listaPagosUl.appendChild(li);
            });
        } else {
             listaPagosUl.innerHTML = '<li>No hay pagos pendientes en los meses anteriores del año actual.</li>';
        }
    }

    // --- Funcionalidad de Gráficos ---
    function cargarClientesEnSelectorGraficos() {
        const selector = document.getElementById('cliente-selector-graficos');
        selector.innerHTML = '<option value="">-- Selecciona un cliente --</option>'; // Limpiar y añadir opción por defecto

        clientes.forEach(cliente => {
            const option = document.createElement('option');
            option.value = cliente.id;
            option.textContent = cliente.nombre;
            selector.appendChild(option);
        });

         // Cargar opciones de año en el selector de la gráfica de pastel
         cargarSelectoresAñoPie();
    }

     function cargarSelectoresAñoPie() {
         const yearSelectorPie = document.getElementById('year-selector-pie');
         const añosDisponibles = new Set();

         // Obtener todos los años con datos de todos los clientes
         clientes.forEach(cliente => {
             Object.keys(cliente.datosPorAño).forEach(año => añosDisponibles.add(parseInt(año)));
         });

         // Añadir el año actual si no está presente
         añosDisponibles.add(añoActual);

         const añosOrdenados = Array.from(añosDisponibles).sort((a, b) => b - a); // Ordenar de más reciente a más antiguo

         yearSelectorPie.innerHTML = ''; // Limpiar opciones actuales
         añosOrdenados.forEach(año => {
             const option = document.createElement('option');
             option.value = año;
             option.textContent = año;
             yearSelectorPie.appendChild(option);
         });
         // Seleccionar el año actual por defecto
         yearSelectorPie.value = añoActual;
     }


    function mostrarGraficosCliente() {
        const selector = document.getElementById('cliente-selector-graficos');
        const clienteId = parseInt(selector.value);
        const graficosArea = document.getElementById('graficos-area');
        const noClienteSelected = document.getElementById('no-cliente-selected');
        const mensajePersonalizado = document.getElementById('mensaje-personalizado-graficos');

        // Destruir gráficos existentes antes de crear nuevos
        if (graficoAnualChart) {
            graficoAnualChart.destroy();
            graficoAnualChart = null;
        }
        if (graficoMensualPieChart) { // Destruir gráfico de pastel
            graficoMensualPieChart.destroy();
            graficoMensualPieChart = null;
        }


        if (clienteId) {
            const cliente = clientes.find(c => c.id === clienteId);
            if (cliente) {
                // Mostrar el área de gráficos y ocultar el mensaje de no seleccionado
                graficosArea.style.display = 'block';
                noClienteSelected.style.display = 'none';

                // Mostrar mensaje personalizado
                mensajePersonalizado.textContent = `Este es tu resumen financiero para ${cliente.nombre}:`;

                // --- Generar Gráfico Anual (usando datos mensuales como línea) ---
                const ctxAnual = document.getElementById('graficoAnual').getContext('2d');
                // Para el gráfico anual, vamos a mostrar la evolución mensual del año actual por defecto
                const datosMensualesAñoActual = cliente.datosPorAño[añoActual] || [];
                 graficoAnualChart = new Chart(ctxAnual, {
                     type: 'line', // Cambiado a línea para mostrar evolución mensual
                     data: obtenerDatosMensualesParaGrafico(datosMensualesAñoActual), // Usar la función de datos mensuales
                     options: {
                         responsive: true,
                         maintainAspectRatio: false,
                         scales: {
                             y: {
                                 beginAtZero: true
                             }
                         },
                         plugins: {
                             title: {
                                 display: true,
                                 text: `Evolución Mensual (${añoActual})`,
                                 color: 'white' // Título blanco
                             },
                             legend: {
                                 labels: {
                                     color: '#eee' // Leyenda blanca
                                 }
                             }
                         }
                     }
                 });

                // Cargar selectores de mes y año para la gráfica de pastel
                 cargarSelectoresAñoPie();
                 // Mostrar la gráfica de pastel inicial (puede ser del primer mes o el actual)
                 updateMonthlyPieChart();


            }
        } else {
            // Ocultar el área de gráficos y mostrar el mensaje de no seleccionado
            graficosArea.style.display = 'none';
            noClienteSelected.style.display = 'block';
        }
    }

    // Función para actualizar la gráfica de pastel mensual
    function updateMonthlyPieChart() {
        const cliente = clientes.find(c => c.id === parseInt(document.getElementById('cliente-selector-graficos').value));
        if (!cliente) return;

        const mesSeleccionado = document.getElementById('month-selector-pie').value;
        const añoSeleccionado = parseInt(document.getElementById('year-selector-pie').value);

        // Destruir gráfico de pastel existente antes de crear uno nuevo
        if (graficoMensualPieChart) {
            graficoMensualPieChart.destroy();
            graficoMensualPieChart = null;
        }

        const datosMesAño = (cliente.datosPorAño[añoSeleccionado] || []).find(d => d.mes === mesSeleccionado);

        const ctxPie = document.getElementById('graficoMensualPie').getContext('2d');
        const legendContainer = document.getElementById('pie-chart-legend');
        legendContainer.innerHTML = ''; // Limpiar leyenda anterior

        if (datosMesAño) {
            const datosParaPie = obtenerDatosParaGraficaPastel(datosMesAño);

            graficoMensualPieChart = new Chart(ctxPie, {
                type: 'pie',
                data: datosParaPie,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false // Ocultar leyenda por defecto de Chart.js
                        },
                        title: {
                            display: true,
                            text: `Desglose de ${mesSeleccionado} ${añoSeleccionado}`,
                            color: 'white' // Título blanco
                        }
                    }
                }
            });

            // Generar leyenda personalizada
            const total = datosMesAño.ingresos + datosMesAño.gastos + datosMesAño.impuestos;
            const legendData = [
                { label: 'Ingresos', value: datosMesAño.ingresos, color: datosParaPie.datasets[0].backgroundColor[0] },
                { label: 'Gastos', value: datosMesAño.gastos, color: datosParaPie.datasets[0].backgroundColor[1] },
                { label: 'Impuestos', value: datosMesAño.impuestos, color: datosParaPie.datasets[0].backgroundColor[2] }
            ];

            legendData.forEach(item => {
                const legendItem = document.createElement('div');
                legendItem.classList.add('pie-chart-legend-item');
                legendItem.innerHTML = `
                    <div class="pie-chart-legend-color" style="background-color: ${item.color}"></div>
                    <span>${item.label}: $${item.value.toFixed(2)} (${total > 0 ? (item.value / total * 100).toFixed(1) : 0}%)</span>
                `;
                legendContainer.appendChild(legendItem);
            });

        } else {
             legendContainer.innerHTML = '<div class="text-center text-gray-600">No hay datos para este mes y año.</div>';
        }
    }


     // Funciones para preparar datos para Chart.js
     function obtenerDatosAnualesParaGrafico(datosPorAño) {
         const años = Object.keys(datosPorAño).sort();
         const ingresosAnuales = años.map(año => {
             const total = datosPorAño[año].reduce((sum, mes) => sum + mes.ingresos, 0);
             return total;
         });
          const gastosAnuales = años.map(año => {
             const total = datosPorAño[año].reduce((sum, mes) => sum + mes.gastos, 0);
             return total;
         });
          const impuestosAnuales = años.map(año => {
             const total = datosPorAño[año].reduce((sum, mes) => sum + mes.impuestos, 0);
             return total;
         });


         return {
             labels: años,
             datasets: [
                 { label: 'Ingresos', data: ingresosAnuales, backgroundColor: 'rgba(75, 192, 192, 0.8)', borderColor: 'rgba(75, 192, 192, 1)', borderWidth: 1 },
                 { label: 'Gastos', data: gastosAnuales, backgroundColor: 'rgba(255, 99, 132, 0.8)', borderColor: 'rgba(255, 99, 132, 1)', borderWidth: 1 },
                 { label: 'Impuestos', data: impuestosAnuales, backgroundColor: 'rgba(54, 162, 235, 0.8)', borderColor: 'rgba(54, 162, 235, 1)', borderWidth: 1 }
             ]
         };
     }

     function obtenerDatosMensualesParaGrafico(datosMensuales) {
         // Asegurarse de que los datos estén ordenados por mes
         const datosOrdenados = [...datosMensuales].sort((a, b) => meses.indexOf(a.mes) - meses.indexOf(b.mes));

         const ingresosMensuales = datosOrdenados.map(dato => dato.ingresos);
         const gastosMensuales = datosOrdenados.map(dato => dato.gastos);
         const impuestosMensuales = datosOrdenados.map(dato => dato.impuestos);

          return {
             labels: datosOrdenados.map(dato => dato.mes), // Usar los meses de los datos ordenados
             datasets: [
                 { label: 'Ingresos', data: ingresosMensuales, borderColor: 'rgba(75, 192, 192, 1)', backgroundColor: 'rgba(75, 192, 192, 0.4)', fill: true, tension: 0.4 }, /* Mayor opacidad y tensión */
                 { label: 'Gastos', data: gastosMensuales, borderColor: 'rgba(255, 99, 132, 1)', backgroundColor: 'rgba(255, 99, 132, 0.4)', fill: true, tension: 0.4 }, /* Mayor opacidad y tensión */
                 { label: 'Impuestos', data: impuestosMensuales, borderColor: 'rgba(54, 162, 235, 1)', backgroundColor: 'rgba(54, 162, 235, 0.4)', fill: true, tension: 0.4 } /* Mayor opacidad y tensión */
             ]
         };
     }

     function obtenerDatosParaGraficaPastel(datoMensual) {
         return {
             labels: ['Ingresos', 'Gastos', 'Impuestos'],
             datasets: [{
                 data: [datoMensual.ingresos, datoMensual.gastos, datoMensual.impuestos],
                 backgroundColor: [
                     'rgba(75, 192, 192, 0.8)', // Ingresos (Verde/Azul)
                     'rgba(255, 99, 132, 0.8)', // Gastos (Rojo)
                     'rgba(54, 162, 235, 0.8)'  // Impuestos (Azul)
                 ],
                 borderColor: [
                      'rgba(75, 192, 192, 1)',
                     'rgba(255, 99, 132, 1)',
                     'rgba(54, 162, 235, 1)'
                 ],
                 borderWidth: 1
             }]
         };
     }


    // --- Funcionalidad de Descarga de Datos ---
    function downloadData() {
        // Convertir el array de clientes a una cadena JSON
        const data = JSON.stringify(clientes, null, 2); // null, 2 para formatear el JSON con indentación

        // Crear un Blob con el contenido JSON
        const blob = new Blob([data], { type: 'application/json' });

        // Crear un enlace de descarga temporal
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'contacloud_data.json'; // Nombre del archivo a descargar

        // Simular un clic en el enlace para iniciar la descarga
        document.body.appendChild(a);
        a.click();

        // Limpiar el enlace temporal
        document.body.removeChild(a);

        // Liberar el objeto URL
        URL.revokeObjectURL(a.href);
    }


    // Inicializar la aplicación mostrando la pestaña de inicio y cargando datos iniciales
    document.addEventListener('DOMContentLoaded', () => {
        // Cargar datos guardados si existen (opcional)
        cargarDatos();
        // Mostrar la vista principal y la pestaña de inicio
        mostrarVista('main');
        openTab(null, 'inicio');
        // Actualizar el resumen con los datos iniciales (vacíos o cargados)
        actualizarResumenInicio();
    });

     // Función para guardar datos en localStorage (opcional)
    function guardarDatos() {
        localStorage.setItem('clientes', JSON.stringify(clientes));
    }

    // Función para cargar datos de localStorage (opcional)
    function cargarDatos() {
        const clientesGuardados = localStorage.getItem('clientes');
        if (clientesGuardados) {
            clientes = JSON.parse(clientesGuardados);
            // Asegurarse de que los clientes cargados tengan la estructura esperada (datosPorAño, etc.)
            clientes.forEach(cliente => {
                // Convertir estructuras antiguas si existen (para compatibilidad con versiones anteriores)
                if (cliente.datosMensuales && !cliente.datosPorAño) {
                    cliente.datosPorAño = { [añoActual]: cliente.datosMensuales };
                    delete cliente.datosMensuales; // Eliminar la propiedad antigua
                }
                 if (cliente.declaracionesMensuales && !cliente.declaracionesPorAño) {
                    cliente.declaracionesPorAño = { [añoActual]: cliente.declaracionesMensuales };
                    delete cliente.declaracionesMensuales; // Eliminar la propiedad antigua
                 }
                 if (cliente.pagosMensuales && !cliente.pagosPorAño) {
                    cliente.pagosPorAño = { [añoActual]: cliente.pagosMensuales };
                    delete cliente.pagosMensuales; // Eliminar la propiedad antigua
                 }


                // Asegurar que el año actual exista en las estructuras por año si no hay datos
                 if (!cliente.datosPorAño[añoActual]) {
                     cliente.datosPorAño[añoActual] = meses.map(mes => ({ mes: mes, ingresos: 0, gastos: 0, impuestos: 0 }));
                 } else {
                     // Asegurar que todos los meses existan para el año actual y ordenar
                     const mesesExistentes = cliente.datosPorAño[añoActual].map(d => d.mes);
                     meses.forEach(mes => {
                         if (!mesesExistentes.includes(mes)) {
                             cliente.datosPorAño[añoActual].push({ mes: mes, ingresos: 0, gastos: 0, impuestos: 0 });
                         }
                     });
                      cliente.datosPorAño[añoActual].sort((a, b) => meses.indexOf(a.mes) - meses.indexOf(b.mes));
                 }

                 if (!cliente.declaracionesPorAño[añoActual]) {
                     cliente.declaracionesPorAño[añoActual] = meses.map(mes => ({ mes: mes, completada: false }));
                 } else {
                     const mesesExistentes = cliente.declaracionesPorAño[añoActual].map(d => d.mes);
                     meses.forEach(mes => {
                         if (!mesesExistentes.includes(mes)) {
                             cliente.declaracionesPorAño[añoActual].push({ mes: mes, completada: false });
                         }
                     });
                     cliente.datosPorAño[añoActual].sort((a, b) => meses.indexOf(a.mes) - meses.indexOf(b.mes));
                 }

                 if (!cliente.pagosPorAño[añoActual]) {
                     cliente.pagosPorAño[añoActual] = meses.map(mes => ({ mes: mes, pagado: false }));
                 } else {
                     const mesesExistentes = cliente.pagosPorAño[añoActual].map(p => p.mes);
                     meses.forEach(mes => {
                         if (!mesesExistentes.includes(mes)) {
                             cliente.pagosPorAño[añoActual].push({ mes: mes, pagado: false });
                         }
                     });
                     cliente.pagosPorAño[añoActual].sort((a, b) => meses.indexOf(a.mes) - meses.indexOf(b.mes));
                 }


                 // Asegurar rfc existe
                 if (cliente.rfc === undefined) {
                     cliente.rfc = ''; // O algún valor por defecto
                 }

                 // Asegurar id existe
                 if (cliente.id === undefined) {
                     cliente.id = Date.now() + Math.random(); // Asignar un ID si falta
                 }
            });
        }
    }

     // Guardar datos después de las funciones de modificación
        const originalAgregarCliente = agregarCliente;
        agregarCliente = function() {
            originalAgregarCliente();
            // guardarDatos() ya se llama dentro de la función original ahora
        }

        // La edición de datos mensuales ahora se maneja en handleMonthlyDataEdit

         const originalMarcarDeclaracionMensual = marcarDeclaracionMensual;
         marcarDeclaracionMensual = function(mes, completada) {
             originalMarcarDeclaracionMensual(mes, completada);
             // guardarDatos() ya se llama dentro de la función original ahora
         }

         const originalMarcarPagoMensual = marcarPagoMensual;
         marcarPagoMensual = function(mes, pagado) {
             originalMarcarPagoMensual(mes, pagado);
             // guardarDatos() ya se llama dentro de la función original ahora
         }

         const originalGuardarEdicionCliente = guardarEdicionCliente;
         guardarEdicionCliente = function() {
             originalGuardarEdicionCliente();
             // guardarDatos() ya se llama dentro de la función original ahora
         }


</script>

</body>
</html>
