<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contacloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'], // Usar Inter como fuente principal
                    },
                    colors: {
                        // Colores de fondo inspirados en la última imagen (azul oscuro/morado)
                        'gradient-main-start': '#2a2a4a', /* Azul oscuro */
                        'gradient-main-end': '#4a2a4a', /* Morado oscuro */
                        // Definir colores para los degradados de elementos (mantener un contraste)
                        'gradient-element-start': '#6a4a8a', /* Tono morado */
                        'gradient-element-end': '#8a6a4a', /* Tono dorado/naranja */
                        'gradient-element-hover-start': '#5a3a7a',
                        'gradient-element-hover-end': '#7a5a3a',
                        // Colores para el menú lateral (fondo oscuro, texto blanco)
                        'sidebar-bg': '#1a1a3a', /* Azul muy oscuro para la barra lateral */
                        'sidebar-link': '#ffffff', /* Blanco para enlaces */
                        'sidebar-link-hover': '#e0e0e0', /* Gris claro al pasar el ratón */
                        'sidebar-active': '#4a2a4a', /* Morado oscuro para activo */
                    }
                }
            }
        }
    </script>
    <style>
        /* Estilos Generales y Degradado */
        body {
            font-family: 'Inter', sans-serif;
            /* Aplicar el degradado de fondo de la última imagen */
            background: linear-gradient(to right, var(--tw-gradient-main-start) 0%, var(--tw-gradient-main-end) 100%);
            --tw-gradient-main-start: #2a2a4a; /* Azul oscuro */
            --tw-gradient-main-end: #4a2a4a; /* Morado oscuro */
            color: #333;
            line-height: 1.6;
            min-height: 100vh; /* Asegura que el degradado cubra toda la altura */
            box-sizing: border-box;
            display: flex; /* Usar flexbox para el layout principal */
        }
         /* Estilos del Menú Lateral */
        .sidebar {
            width: 200px; /* Ancho del menú lateral */
            background-color: var(--tw-sidebar-bg);
            color: var(--tw-sidebar-link);
            padding: 20px;
            display: flex;
            flex-direction: column;
            border-radius: 0 20px 20px 0; /* Bordes redondeados solo a la derecha */
            box-shadow: 4px 0 10px rgba(0, 0, 0, 0.3); /* Sombra más pronunciada */
             flex-shrink: 0; /* Evita que se encoja */
        }
        .sidebar h2 {
            color: white;
            font-size: 1.6rem;
            font-weight: bold;
            margin-bottom: 30px;
            text-align: center;
        }
        .sidebar-nav-link {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: 10px;
            color: white !important; /* Texto siempre blanco */
            text-decoration: none;
            transition: all 0.3s ease;
            font-size: 1rem;
        }
        .sidebar-nav-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white !important; /* Color al pasar el ratón (blanco) */
        }
        .sidebar-nav-link.active {
            background-color: var(--tw-sidebar-active);
            color: white !important; /* Texto blanco para activo */
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3); /* Sombra más pronunciada */
        }
        .sidebar-nav-link i {
            margin-right: 10px; /* Espacio para iconos si se usan */
        }

         /* Contenido Principal */
        .main-content {
            flex-grow: 1; /* Ocupar el espacio restante */
            padding: 20px;
            overflow-y: auto; /* Permitir scroll si el contenido es largo */
        }

        .container {
            max-width: 1200px;
            margin: 0 auto; /* Centrar el contenido dentro del main-content */
            padding: 30px;
            background-color: rgba(255, 255, 255, 0.1); /* Fondo con baja opacidad para ver el fondo */
            border-radius: 30px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5); /* Sombra más pronunciada */
            backdrop-filter: blur(8px); /* Desenfoque */
             color: #eee; /* Texto claro para contrastar con el fondo oscuro */
        }
        .container h2, .container h3, .container h4 {
            color: white; /* Asegurar que los títulos sean blancos */
        }
         .container label {
             color: #ccc; /* Color para las etiquetas */
         }

        .tab-content {
            display: none;
            padding-top: 0;
        }
        .tab-content.active {
            display: block;
        }
        .card {
            background-color: rgba(255, 255, 255, 0.15); /* Fondo de tarjeta con opacidad */
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
             backdrop-filter: blur(5px); /* Ligero desenfoque en las tarjetas */
             color: #eee; /* Texto claro dentro de las tarjetas */
        }
         .card h3, .card h4 {
             color: white; /* Asegurar que los títulos de las tarjetas sean blancos */
         }

        .input-field {
            padding: 16px;
            border: 1px solid rgba(255, 255, 255, 0.3); /* Borde con opacidad */
            background-color: rgba(255, 255, 255, 0.1); /* Fondo con opacidad */
            color: white; /* Texto blanco */
            border-radius: 12px;
            margin-bottom: 15px;
            width: 100%;
            box-sizing: border-box;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
         .input-field::placeholder {
             color: rgba(255, 255, 255, 0.6); /* Color del placeholder con opacidad */
         }
        .input-field:focus {
            outline: none;
            border-color: rgba(0, 123, 255, 0.6); /* Borde azul al enfocar con opacidad */
            box-shadow: 0 0 8px rgba(0, 123, 255, 0.6);
            background-color: rgba(255, 255, 255, 0.2); /* Fondo más claro al enfocar */
        }

        /* Estilo para el texto en los selectores cuando están desplegados */
        .input-field option {
            color: #333; /* Texto negro para las opciones del select */
        }

        .btn {
            padding: 16px 28px;
            background: linear-gradient(to right, var(--tw-gradient-element-start) 0%, var(--tw-gradient-element-end) 100%);
             --tw-gradient-element-start: #6a4a8a; /* Tono morado */
             --tw-gradient-element-end: #8a6a4a; /* Tono dorado/naranja */
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: medium;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.4);
        }
        .btn:hover {
            --tw-gradient-element-start: #5a3a7a;
            --tw-gradient-element-end: #7a5a3a;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);
        }
        .btn:active {
            --tw-gradient-element-start: #4a2a6a;
            --tw-gradient-element-end: #6a4a2a;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.6);
        }
         .btn-sm {
             padding: 10px 16px;
             font-size: 0.9rem;
         }
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 44px 8px rgba(0, 0, 0, 0.2);
        }
        .table th, .table td {
            border: 1px solid rgba(255, 255, 255, 0.2); /* Borde con opacidad */
            padding: 15px;
            text-align: left;
             color: #eee; /* Texto claro en la tabla */
        }
         .table th {
             background-color: rgba(242, 242, 242, 0.1); /* Fondo de encabezado con opacidad */
             font-weight: medium;
             color: white; /* Texto blanco en encabezados */
         }
         .table td[contenteditable="true"] {
             background-color: rgba(238, 238, 255, 0.1); /* Ligero fondo con opacidad */
             cursor: text;
             transition: background-color 0.2s ease;
         }
          .table td[contenteditable="true"]:focus {
             outline: none;
             background-color: rgba(221, 221, 255, 0.2); /* Fondo más visible al enfocar */
          }

        .table tr:nth-child(even) {
            background-color: rgba(249, 249, 249, 0.05); /* Rayado para filas con opacidad muy baja */
        }
         /* Estilos para la vista de detalle de cliente */
         #detalle-cliente-view {
             display: none;
             padding: 30px;
             background-color: rgba(255, 255, 255, 0.1); /* Fondo con opacidad */
             border-radius: 30px;
             box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);
             backdrop-filter: blur(8px);
             margin: 20px auto;
             max-width: 1200px;
             color: #eee; /* Texto claro */
         }
          #detalle-cliente-view h2 {
             background: linear-gradient(to right, var(--tw-gradient-element-start) 0%, var(--tw-gradient-element-end) 100%);
             --tw-gradient-element-start: #6a4a8a; /* Tono morado */
             --tw-gradient-element-end: #8a6a4a; /* Tono dorado/naranja */
             -webkit-background-clip: text;
             -webkit-text-fill-color: transparent;
             font-size: 2.5rem;
             margin-bottom: 10px;
             font-weight: bold;
          }
          #detalle-cliente-view label {
             color: #ccc; /* Color para las etiquetas */
          }
          #detalle-cliente-view .text-gray-700 { /* Ajustar color de texto para RFC */
             color: #ccc;
          }


         .dashboard-placeholder {
             height: 300px;
             background: linear-gradient(to right, rgba(106, 74, 138, 0.3), rgba(138, 106, 74, 0.3)); /* Degradado suave con opacidad */
             border-radius: 18px;
             display: flex;
             flex-direction: column;
             align-items: center;
             justify-content: center;
             color: #ccc; /* Texto claro */
             font-size: 1.5rem;
             margin-bottom: 30px;
             box-shadow: inset 0 3px 6px rgba(0, 0, 0, 0.2); /* Sombra interior */
         }
          .dashboard-placeholder p {
              color: #bbb; /* Texto más claro dentro del placeholder */
          }

         .modal {
             display: none;
             position: fixed;
             z-index: 100;
             left: 0;
             top: 0;
             width: 100%;
             height: 100%;
             overflow: auto;
             background-color: rgba(0,0,0,0.8); /* Fondo más oscuro */
             justify-content: center;
             align-items: center;
             animation: fadeIn 0.3s ease-out;
         }
         .modal-content {
             background-color: rgba(255, 255, 255, 0.95); /* Fondo casi opaco */
             margin: auto;
             padding: 30px;
             border: 1px solid rgba(136, 136, 136, 0.5); /* Borde con opacidad */
             width: 90%;
             max-width: 550px;
             border-radius: 20px;
             box-shadow: 0 10px 20px rgba(0,0,0,0.4);
             animation: slideIn 0.3s ease-out;
             color: #333; /* Texto oscuro dentro del modal */
         }
         .modal-content h3 {
             color: #333; /* Título oscuro dentro del modal */
         }
         .close-button {
             color: #aaa;
             float: right;
             font-size: 32px;
             font-weight: bold;
             transition: color 0.3s ease;
         }
         .close-button:hover,
         .close-button:focus {
             color: #000;
             text-decoration: none;
             cursor: pointer;
         }
         /* Animaciones */
         @keyframes fadeIn {
             from { opacity: 0; }
             to { opacity: 1; }
         }
         @keyframes slideIn {
             from { transform: translateY(-20px); opacity: 0; }
             to { transform: translateY(0); opacity: 1; }
         }

         /* Estilo para el nuevo elemento visual en Inicio */
         .inicio-visual-card {
             background: linear-gradient(to right, var(--tw-gradient-element-start) 0%, var(--tw-gradient-element-end) 100%);
             --tw-gradient-element-start: #6a4a8a; /* Tono morado */
             --tw-gradient-element-end: #8a6a4a; /* Tono dorado/naranja */
             color: white;
             border-radius: 20px;
             padding: 30px;
             text-align: center;
             font-size: 1.8rem;
             font-weight: bold;
             box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
         }
          /* Estilos para el área de gráficos */
          #graficos .card {
              padding: 30px;
              /* Aplicar degradado al card de gráficos */
              background: linear-gradient(to bottom right, rgba(255, 255, 255, 0.15), rgba(240, 240, 255, 0.1)); /* Degradado con opacidad */
          }
         #graficos .chart-container {
             margin-bottom: 30px;
             background-color: rgba(249, 249, 249, 0.1); /* Fondo con opacidad */
             border-radius: 15px;
             padding: 20px;
             box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
         }
          #graficos-area h3 {
              background: linear-gradient(to right, var(--tw-gradient-element-start) 0%, var(--tw-gradient-element-end) 100%);
              --tw-gradient-element-start: #6a4a8a; /* Tono morado */
              --tw-gradient-element-end: #8a6a4a; /* Tono dorado/naranja */
              -webkit-background-clip: text;
              -webkit-text-fill-color: transparent;
              font-size: 1.8rem;
              font-weight: bold;
              color: white !important; /* Texto del mensaje personalizado siempre blanco */
          }
          /* Contenedor para limitar el tamaño del canvas del gráfico */
          .chart-canvas-container {
              position: relative; /* Necesario para que el canvas ocupe el 100% del contenedor */
              height: 300px; /* Altura fija para limitar el tamaño del gráfico */
              width: 100%; /* Ancho completo del contenedor */
          }
          .chart-canvas-container canvas {
              display: block; /* Evita espacio extra debajo del canvas */
              width: 100% !important; /* Asegura que Chart.js use el 100% del ancho del contenedor */
              height: 100% !important; /* Asegura que Chart.js use el 100% de la altura del contenedor */
          }
          /* Estilos para la leyenda de la gráfica de pastel */
          .pie-chart-legend {
              display: flex;
              flex-direction: column;
              align-items: flex-start;
              margin-left: 20px;
              color: #eee; /* Texto claro para la leyenda */
          }
          .pie-chart-legend-item {
              display: flex;
              align-items: center;
              margin-bottom: 5px;
          }
          .pie-chart-legend-color {
              width: 15px;
              height: 15px;
              border-radius: 3px;
              margin-right: 10px;
          }
    </style>
</head>
<body>

<div class="sidebar">
    <h2>Contacloud</h2>
    <a href="#" class="sidebar-nav-link active" onclick="openTab(event, 'inicio')">
        Inicio
    </a>
    <a href="#" class="sidebar-nav-link" onclick="openTab(event, 'clientes')">
         Clientes
    </a>
     <a href="#" class="sidebar-nav-link" onclick="openTab(event, 'graficos')">
        Gráficos
    </a>
    </div>

<div class="main-content">
    <div class="container">
        <div id="inicio" class="tab-content active">
            <h2 class="text-2xl font-semibold mb-6">Resumen General</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                 <div class="inicio-visual-card col-span-1 md:col-span-2">
                     ¡Bienvenido a Contacloud!
                     <p class="text-lg font-normal mt-2">Controla tus declaraciones y pagos pendientes de un vistazo.</p>
                 </div>
                <div class="card">
                    <h3 class="text-xl font-medium mb-4">Declaraciones Pendientes</h3>
                    <ul id="lista-pendientes">
                        </ul>
                </div>
                <div class="card">
                    <h3 class="text-xl font-medium mb-4">Pagos Pendientes</h3>
                    <ul id="lista-pagos">
                        </ul>
                </div>
            </div>
        </div>

        <div id="clientes" class="tab-content">
            <h2 class="text-2xl font-semibold mb-6">Gestión de Clientes</h2>
            <div class="mb-6 flex flex-col md:flex-row gap-4">
                <input type="text" id="nombre-cliente" class="input-field flex-grow" placeholder="Nombre del Cliente">
                <input type="text" id="rfc-cliente" class="input-field flex-grow" placeholder="RFC">
                <button class="btn" onclick="agregarCliente()">Agregar Cliente</button>
            </div>
            <div id="lista-clientes" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                </div>
        </div>

        <div id="graficos" class="tab-content">
            <h2 class="text-2xl font-semibold mb-6">Gráficos de Clientes</h2>
            <div class="card">
                <div class="mb-6">
                    <label for="cliente-selector-graficos" class="mr-4 text-lg font-medium">Seleccionar Cliente:</label>
                    <select id="cliente-selector-graficos" class="input-field w-auto inline-block" onchange="mostrarGraficosCliente()">
                        <option value="">-- Selecciona un cliente --</option>
                        </select>
                </div>
                <div id="graficos-area" style="display: none;">
                    <h3 id="mensaje-personalizado-graficos" class="text-xl font-semibold mb-6"></h3>

                    <div class="chart-container">
                        <h4 class="text-lg font-medium mb-4">Resumen Anual (Evolución Mensual)</h4>
                        <div class="chart-canvas-container">
                            <canvas id="graficoAnual"></canvas>
                        </div>
                         <div class="mt-4 text-sm text-gray-700">
                             <p>Nota: Este gráfico muestra la evolución mensual de Ingresos, Gastos e Impuestos para el año actual.</p>
                         </div>
                    </div>

                    <div class="chart-container">
                        <h4 class="text-lg font-medium mb-4">Gráfica Mensual (Ingresos, Gastos, Impuestos)</h4>
                         <div class="mb-4 flex items-center gap-4">
                             <label for="month-selector-pie">Mes:</label>
                             <select id="month-selector-pie" class="input-field w-auto inline-block">
                                 <option value="Enero">Enero</option>
                                 <option value="Febrero">Febrero</option>
                                 <option value="Marzo">Marzo</option>
                                 <option value="Abril">Abril</option>
                                 <option value="Mayo">Mayo</option>
                                 <option value="Junio">Junio</option>
                                 <option value="Julio">Julio</option>
                                 <option value="Agosto">Agosto</option>
                                 <option value="Septiembre">Septiembre</option>
                                 <option value="Octubre">Octubre</option>
                                 <option value="Noviembre">Noviembre</option>
                                 <option value="Diciembre">Diciembre</option>
                             </select>
                             <label for="year-selector-pie">Año:</label>
                             <select id="year-selector-pie" class="input-field w-auto inline-block">
                                 </select>
                              <button class="btn btn-sm" onclick="updateMonthlyPieChart()">Mostrar Gráfica</button>
                         </div>
                         <div class="flex flex-col md:flex-row items-center">
                             <div class="chart-canvas-container flex-grow">
                                 <canvas id="graficoMensualPie"></canvas>
                             </div>
                             <div id="pie-chart-legend" class="pie-chart-legend mt-4 md:mt-0">
                                 </div>
                         </div>

                         <div class="mt-4 text-sm text-gray-700">
                             <p>Nota: Selecciona un mes y año para ver el desglose de Ingresos, Gastos e Impuestos en la gráfica de pastel.</p>
                         </div>
                    </div>
                     </div>
                 <div id="no-cliente-selected" class="text-center text-gray-600 text-lg mt-8">
                     Selecciona un cliente para ver sus gráficos.
                 </div>
            </div>
        </div>

    </div>
</div>


<div id="detalle-cliente-view" class="container">
    <button class="btn mb-6" onclick="cerrarDetalleCliente()">← Volver a Clientes</button>
    <h2 id="nombre-cliente-detalle"></h2>
     <p class="text-lg text-gray-700 mb-6">RFC: <span id="rfc-cliente-detalle"></span></p>

     <button class="btn btn-sm mb-6" onclick="abrirModalEditarCliente()">Editar Cliente</button>

    <div class="card">
         <h3 class="text-xl font-medium mb-4">Resumen Financiero Anual</h3>
         <div class="dashboard-placeholder mb-6">
             Espacio para Gráficos y Dashboards
             <p class="text-sm text-gray-600 mt-2">Aquí se mostrarían gráficos de ingresos, gastos, impuestos por mes o año.</p>
         </div>
         <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center font-bold text-xl text-gray-800">
             <div>Ingresos Anuales: $<span id="total-ingresos-cliente">0</span></div>
             <div>Gastos Anuales: $<span id="total-gastos-cliente">0</span></div>
             <div>Impuestos Anuales: $<span id="total-impuestos-cliente">0</span></div>
         </div>
    </div>


     <div class="card">
         <h3 class="text-xl font-medium mb-4">Datos Mensuales</h3>
          <div class="mb-4">
             <label for="year-selector-data" class="mr-2">Año:</label>
             <select id="year-selector-data" class="input-field w-auto inline-block" onchange="mostrarDatosClientePorAño()">
                 </select>
         </div>
         <table class="table">
             <thead>
                 <tr>
                     <th>Mes</th>
                     <th>Ingresos</th>
                     <th>Gastos</th>
                     <th>Impuestos</th>
                 </tr>
             </thead>
             <tbody id="tabla-datos-mensuales">
                 </tbody>
         </table>
         </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
         <div class="card">
             <h3 class="text-xl font-medium mb-4">Declaraciones Mensuales <span id="declaraciones-year-title"></span></h3>
              <div class="mb-4">
                 <label for="year-selector-declaraciones" class="mr-2">Año:</label>
                 <select id="year-selector-declaraciones" class="input-field w-auto inline-block" onchange="mostrarDatosClientePorAño()">
                     </select>
             </div>
             <table class="table">
                 <thead>
                     <tr>
                         <th>Mes</th>
                         <th>Completada</th>
                     </tr>
                 </thead>
                 <tbody id="tabla-declaraciones-mensuales">
                     </tbody>
             </table>
         </div>
         <div class="card">
             <h3 class="text-xl font-medium mb-4">Estado de Pago Mensual <span id="pagos-year-title"></span></h3>
              <div class="mb-4">
                 <label for="year-selector-pagos" class="mr-2">Año:</label>
                 <select id="year-selector-pagos" class="input-field w-auto inline-block" onchange="mostrarDatosClientePorAño()">
                     </select>
             </div>
              <table class="table">
                 <thead>
                     <tr>
                         <th>Mes</th>
                         <th>Pagado</th>
                     </tr>
                 </thead>
                 <tbody id="tabla-pagos-mensuales">
                     </tbody>
             </table>
         </div>
    </div>


</div>

<div id="modalEditarCliente" class="modal">
  <div class="modal-content">
    <span class="close-button" onclick="cerrarModalEditarCliente()">&times;</span>
    <h3 class="text-xl font-semibold mb-4">Editar Cliente</h3>
    <input type="text" id="edit-nombre-cliente" class="input-field" placeholder="Nombre del Cliente">
    <input type="text" id="edit-rfc-cliente" class="input-field" placeholder="RFC">
    <button class="btn mt-4" onclick="guardarEdicionCliente()">Guardar Cambios</button>
  </div>
</div>


<script>
    // URL de tu Google Apps Script publicado como Web App
    // ¡¡¡REEMPLAZA ESTA URL CON LA TUYA!!!
    const APPS_SCRIPT_URL = 'TU_URL_DE_APPS_SCRIPT_AQUI';

    // Array para almacenar los clientes en el frontend, se llenará desde Google Sheets
    let clientes = [];
    const meses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
    const añoActual = new Date().getFullYear();

    // Variables para gráficos
    let graficoAnualChart = null;
    let graficoMensualPieChart = null;

    // Variable para rastrear el ID del cliente que se está viendo o editando
    let clienteActualId = null;
    let añoSeleccionado = añoActual; // Año por defecto para la vista de detalle y gráficos

    // --- Funciones de Utilidad ---

    // Función para mostrar mensajes de error o éxito
    function mostrarMensaje(mensaje, tipo = 'info') {
        // Implementar una forma de mostrar mensajes al usuario (ej. un div en el HTML)
        console.log(`${tipo.toUpperCase()}: ${mensaje}`);
        //alert(mensaje); // Usar alert solo para depuración, mejor usar un div modal o similar
    }

    // Función para cambiar entre la vista principal (pestañas) y la vista de detalle de cliente
    function mostrarVista(vistaId) {
        const mainContent = document.querySelector('.main-content');
        const detalleClienteView = document.getElementById('detalle-cliente-view');

        if (vistaId === 'main') {
            mainContent.style.display = 'block';
            detalleClienteView.style.display = 'none';
        } else if (vistaId === 'detalle-cliente') {
            mainContent.style.display = 'none';
            detalleClienteView.style.display = 'block';
        }
    }

    // Función para cambiar de pestaña en el menú lateral
    async function openTab(event, tabId) {
         // Asegurarse de estar en la vista principal
         mostrarVista('main');

        // Ocultar todos los contenidos de las pestañas
        const tabContents = document.querySelectorAll('.tab-content');
        tabContents.forEach(content => {
            content.classList.remove('active');
        });

        // Quitar la clase 'active' de todos los enlaces del menú lateral
        const navLinks = document.querySelectorAll('.sidebar-nav-link');
        navLinks.forEach(link => {
            link.classList.remove('active');
        });

        // Mostrar el contenido de la pestaña seleccionada
        document.getElementById(tabId).classList.add('active');

        // Añadir la clase 'active' al enlace del menú lateral seleccionado
        if (event) { // event es null cuando se llama desde DOMContentLoaded
             event.currentTarget.classList.add('active');
        } else {
             // Activar el primer enlace si se llama desde DOMContentLoaded
             document.querySelector('.sidebar-nav-link').classList.add('active');
        }

        // Lógica específica al abrir cada pestaña
        if (tabId === 'inicio') {
            await actualizarResumenInicio(); // Ahora es asíncrono
        }
         if (tabId === 'clientes') {
             await listarClientes(); // Ahora es asíncrono
         }
         if (tabId === 'graficos') {
             await cargarClientesEnSelectorGraficos(); // Ahora es asíncrono
             // Ocultar el área de gráficos hasta que se seleccione un cliente
             document.getElementById('graficos-area').style.display = 'none';
             document.getElementById('no-cliente-selected').style.display = 'block';
         }
    }

    // --- Funcionalidad de Comunicación con Google Apps Script ---

    // Función genérica para enviar datos al Apps Script
    async function enviarDatosAppsScript(action, data = {}) {
        try {
            const response = await fetch(APPS_SCRIPT_URL, {
                method: 'POST', // Usamos POST para enviar datos y acciones
                headers: {
                    // Apps Script a menudo maneja text/plain y parsea el JSON internamente
                    'Content-Type': 'text/plain;charset=utf-8',
                },
                // Enviamos un objeto con la acción a realizar y los datos necesarios
                body: JSON.stringify({ action: action, data: data })
            });

            if (!response.ok) {
                // Si la respuesta HTTP no es 2xx, lanzar un error
                const errorText = await response.text(); // Intentar leer el cuerpo del error
                throw new Error(`Error HTTP: ${response.status} - ${response.statusText}. Detalle: ${errorText}`);
            }

            // Asumimos que el Apps Script siempre devuelve JSON
            const result = await response.json();

            if (result.status === 'error') {
                // Si el script devuelve un status 'error' en su JSON
                 throw new Error(`Error del Apps Script: ${result.message}`);
            }

            return result; // Devuelve el resultado del Apps Script (si status es 'success')

        } catch (error) {
            console.error('Error en la comunicación con Apps Script:', error);
            mostrarMensaje(`Error: ${error.message}`, 'error');
            throw error; // Propagar el error para que las funciones que llaman puedan manejarlo
        }
    }

    // Función genérica para obtener datos del Apps Script (usando GET)
    async function obtenerDatosAppsScript(action, params = {}) {
        try {
            // Construir la URL con parámetros de consulta para GET
            const url = new URL(APPS_SCRIPT_URL);
            url.searchParams.append('action', action);
            for (const key in params) {
                if (params.hasOwnProperty(key)) {
                    url.searchParams.append(key, params[key]);
                }
            }

            const response = await fetch(url, {
                method: 'GET',
            });

            if (!response.ok) {
                 const errorText = await response.text();
                 throw new Error(`Error HTTP: ${response.status} - ${response.statusText}. Detalle: ${errorText}`);
            }

            const result = await response.json();

             if (result.status === 'error') {
                 throw new Error(`Error del Apps Script: ${result.message}`);
             }

            return result.data; // Asumimos que los datos vienen en la propiedad 'data' del JSON de respuesta

        } catch (error) {
            console.error('Error al obtener datos de Apps Script:', error);
            mostrarMensaje(`Error al cargar datos: ${error.message}`, 'error');
            throw error;
        }
    }


    // --- Funcionalidad de Clientes (en la vista principal) ---

    async function agregarCliente() {
        const nombreInput = document.getElementById('nombre-cliente');
        const rfcInput = document.getElementById('rfc-cliente');
        const nombre = nombreInput.value.trim();
        const rfc = rfcInput.value.trim();

        if (nombre && rfc) {
            try {
                // Enviar datos del nuevo cliente al Apps Script
                const result = await enviarDatosAppsScript('addClient', { nombre: nombre, rfc: rfc });

                if (result.status === 'success') {
                    mostrarMensaje('Cliente agregado con éxito.', 'success');
                    nombreInput.value = '';
                    rfcInput.value = '';
                    await listarClientes(); // Volver a cargar la lista después de agregar
                } else {
                     // El error ya se maneja en enviarDatosAppsScript, pero puedes añadir lógica adicional aquí si es necesario
                     mostrarMensaje(`Fallo al agregar cliente: ${result.message}`, 'error');
                }

            } catch (error) {
                // El error ya se maneja en enviarDatosAppsScript
            }
        } else {
            mostrarMensaje('Por favor, completa el nombre y RFC del cliente.', 'warning');
        }
    }

    async function listarClientes() {
        const listaClientesDiv = document.getElementById('lista-clientes');
        listaClientesDiv.innerHTML = ''; // Limpiar lista actual

        try {
            // Obtener la lista de clientes desde el Apps Script
            const clientesData = await obtenerDatosAppsScript('getClients');

            // Actualizar el array local 'clientes' con los datos obtenidos
            clientes = clientesData;

            if (clientes.length === 0) {
                 listaClientesDiv.innerHTML = '<p class="text-center text-gray-600 col-span-full">No hay clientes registrados.</p>';
                 return;
            }

            // Renderizar la lista de clientes en la UI
            clientes.forEach(cliente => {
                const clienteElement = document.createElement('div');
                clienteElement.classList.add('card', 'cursor-pointer');
                // Asume que cada cliente del Apps Script tiene propiedades 'id', 'nombre', 'rfc'
                clienteElement.innerHTML = `
                    <p class="font-semibold">${cliente.nombre}</p>
                    <p class="text-sm text-gray-600">RFC: ${cliente.rfc}</p>
                `;
                // Usar el ID proporcionado por el backend (Apps Script)
                clienteElement.onclick = () => mostrarDetalleCliente(cliente.id);
                listaClientesDiv.appendChild(clienteElement);
            });

        } catch (error) {
            // El error ya se maneja en obtenerDatosAppsScript
             listaClientesDiv.innerHTML = '<p class="text-center text-red-500 col-span-full">Error al cargar clientes.</p>';
        }
    }

    // --- Funcionalidad de Detalle de Cliente (en la nueva vista) ---

    async function mostrarDetalleCliente(clienteId) {
        // Buscar el cliente en el array local (ya cargado por listarClientes)
        const cliente = clientes.find(c => c.id === clienteId);
        if (!cliente) {
            mostrarMensaje('Cliente no encontrado.', 'error');
            return;
        }

        clienteActualId = clienteId; // Guardar el ID del cliente actual
        añoSeleccionado = añoActual; // Resetear al año actual al abrir detalle

        document.getElementById('nombre-cliente-detalle').textContent = cliente.nombre;
        document.getElementById('rfc-cliente-detalle').textContent = cliente.rfc;

        // Cargar opciones en los selectores de año en la vista de detalle
        await cargarSelectoresAñoDetalle(clienteId);

        // Mostrar datos para el año seleccionado
        await mostrarDatosClientePorAño(); // Ahora es asíncrono

        // Cambiar a la vista de detalle de cliente
        mostrarVista('detalle-cliente');
    }

    // Carga los selectores de año en la vista de detalle con los años disponibles para el cliente
    async function cargarSelectoresAñoDetalle(clienteId) {
         const yearSelectors = document.querySelectorAll('#detalle-cliente-view select[id^="year-selector-"]');
         yearSelectors.forEach(selector => selector.innerHTML = ''); // Limpiar selectores

         try {
             // Obtener los años disponibles para este cliente desde el Apps Script
             const añosDisponibles = await obtenerDatosAppsScript('getClientYears', { clientId: clienteId });

             if (añosDisponibles.length === 0) {
                 // Si no hay años, añadir solo el año actual
                 const option = document.createElement('option');
                 option.value = añoActual;
                 option.textContent = añoActual;
                 yearSelectors.forEach(selector => selector.appendChild(option.cloneNode(true)));
             } else {
                 // Añadir los años disponibles y el año actual si no está
                 const allYears = new Set([...añosDisponibles, añoActual]);
                 Array.from(allYears).sort().forEach(year => {
                     const option = document.createElement('option');
                     option.value = year;
                     option.textContent = year;
                      yearSelectors.forEach(selector => selector.appendChild(option.cloneNode(true)));
                 });
             }

             // Establecer el año seleccionado por defecto (añoActual)
             yearSelectors.forEach(selector => selector.value = añoSeleccionado);

         } catch (error) {
             // El error ya se maneja en obtenerDatosAppsScript
              mostrarMensaje('Error al cargar años disponibles.', 'error');
         }
    }


    async function mostrarDatosClientePorAño() {
        if (!clienteActualId) return; // No hacer nada si no hay cliente seleccionado

        const yearSelectorData = document.getElementById('year-selector-data');
        const yearSelectorDeclaraciones = document.getElementById('year-selector-declaraciones');
        const yearSelectorPagos = document.getElementById('year-selector-pagos');

        // Sincronizar los selectores de año en la vista de detalle
        const selectedYear = yearSelectorData.value || añoActual; // Usar el valor del selector de datos como principal
        yearSelectorDeclaraciones.value = selectedYear;
        yearSelectorPagos.value = selectedYear;
        añoSeleccionado = parseInt(selectedYear); // Actualizar la variable global

        document.getElementById('declaraciones-year-title').textContent = `(${añoSeleccionado})`;
        document.getElementById('pagos-year-title').textContent = `(${añoSeleccionado})`;


        const tablaDatosMensualesBody = document.getElementById('tabla-datos-mensuales');
        const tablaDeclaracionesBody = document.getElementById('tabla-declaraciones-mensuales');
        const tablaPagosBody = document.getElementById('tabla-pagos-mensuales');

        tablaDatosMensualesBody.innerHTML = ''; // Limpiar tablas
        tablaDeclaracionesBody.innerHTML = '';
        tablaPagosBody.innerHTML = '';

        try {
            // Obtener todos los datos del cliente para el año seleccionado desde el Apps Script
            const clienteDataAnual = await obtenerDatosAppsScript('getClientDataByYear', {
                clientId: clienteActualId,
                year: añoSeleccionado
            });

            // clienteDataAnual debería contener arrays para datosMensuales, declaracionesMensuales, pagosMensuales
            const datosMensuales = clienteDataAnual.datosMensuales || meses.map(mes => ({ mes: mes, ingresos: 0, gastos: 0, impuestos: 0 }));
            const declaracionesMensuales = clienteDataAnual.declaracionesMensuales || meses.map(mes => ({ mes: mes, completada: false }));
            const pagosMensuales = clienteDataAnual.pagosMensuales || meses.map(mes => ({ mes: mes, pagado: false }));


            // Llenar tabla de Datos Mensuales
            datosMensuales.forEach((item, index) => {
                const row = tablaDatosMensualesBody.insertRow();
                row.innerHTML = `
                    <td>${item.mes}</td>
                    <td contenteditable="true" data-mes="${item.mes}" data-tipo="ingresos">${item.ingresos}</td>
                    <td contenteditable="true" data-mes="${item.mes}" data-tipo="gastos">${item.gastos}</td>
                    <td contenteditable="true" data-mes="${item.mes}" data-tipo="impuestos">${item.impuestos}</td>
                `;
                 // Añadir event listeners para guardar cambios al editar
                 row.querySelectorAll('td[contenteditable="true"]').forEach(cell => {
                     cell.addEventListener('blur', handleDataEdit);
                 });
            });

            // Llenar tabla de Declaraciones
            declaracionesMensuales.forEach((item, index) => {
                 const row = tablaDeclaracionesBody.insertRow();
                 row.innerHTML = `
                     <td>${item.mes}</td>
                     <td>
                         <input type="checkbox" data-mes="${item.mes}" data-tipo="declaracion" ${item.completada ? 'checked' : ''}>
                     </td>
                 `;
                 row.querySelector('input[type="checkbox"]').addEventListener('change', handleCheckboxChange);
            });

             // Llenar tabla de Pagos
            pagosMensuales.forEach((item, index) => {
                 const row = tablaPagosBody.insertRow();
                 row.innerHTML = `
                     <td>${item.mes}</td>
                     <td>
                         <input type="checkbox" data-mes="${item.mes}" data-tipo="pago" ${item.pagado ? 'checked' : ''}>
                     </td>
                 `;
                 row.querySelector('input[type="checkbox"]').addEventListener('change', handleCheckboxChange);
            });

             // Calcular y mostrar totales anuales (esto se haría con los datos obtenidos)
             const totalIngresos = datosMensuales.reduce((sum, item) => sum + parseFloat(item.ingresos || 0), 0);
             const totalGastos = datosMensuales.reduce((sum, item) => sum + parseFloat(item.gastos || 0), 0);
             const totalImpuestos = datosMensuales.reduce((sum, item) => sum + parseFloat(item.impuestos || 0), 0);

             document.getElementById('total-ingresos-cliente').textContent = totalIngresos.toFixed(2);
             document.getElementById('total-gastos-cliente').textContent = totalGastos.toFixed(2);
             document.getElementById('total-impuestos-cliente').textContent = totalImpuestos.toFixed(2);


        } catch (error) {
            // El error ya se maneja en obtenerDatosAppsScript
             tablaDatosMensualesBody.innerHTML = '<tr><td colspan="4" class="text-center text-red-500">Error al cargar datos mensuales.</td></tr>';
             tablaDeclaracionesBody.innerHTML = '<tr><td colspan="2" class="text-center text-red-500">Error al cargar declaraciones.</td></tr>';
             tablaPagosBody.innerHTML = '<tr><td colspan="2" class="text-center text-red-500">Error al cargar pagos.</td></tr>';
        }
    }

    // Manejar la edición de celdas de datos mensuales (Ingresos, Gastos, Impuestos)
    async function handleDataEdit(event) {
        const cell = event.target;
        const mes = cell.dataset.mes;
        const tipo = cell.dataset.tipo; // 'ingresos', 'gastos', 'impuestos'
        const valor = parseFloat(cell.textContent) || 0; // Convertir a número, default 0 si no es válido

        if (!clienteActualId || !mes || !tipo) return;

        try {
            // Enviar la actualización al Apps Script
            const result = await enviarDatosAppsScript('updateMonthlyData', {
                clientId: clienteActualId,
                year: añoSeleccionado,
                month: mes,
                type: tipo, // 'ingresos', 'gastos', 'impuestos'
                value: valor
            });

            if (result.status === 'success') {
                mostrarMensaje(`Datos de ${tipo} para ${mes} actualizados.`, 'success');
                // Opcional: Volver a cargar los datos del año para actualizar totales y gráficos si están visibles
                 await mostrarDatosClientePorAño();
                 // Si estás en la pestaña de gráficos y este cliente está seleccionado, actualiza los gráficos
                 const clienteSelectorGraficos = document.getElementById('cliente-selector-graficos');
                 if (document.getElementById('graficos').classList.contains('active') && clienteSelectorGraficos.value == clienteActualId) {
                     mostrarGraficosCliente(); // Esto recargará los gráficos
                 }

            } else {
                 mostrarMensaje(`Fallo al actualizar datos de ${tipo}: ${result.message}`, 'error');
                 // Opcional: Revertir el contenido de la celda a su valor anterior si falla
            }
        } catch (error) {
             mostrarMensaje(`Error al guardar datos de ${tipo}: ${error.message}`, 'error');
             // Opcional: Revertir el contenido de la celda a su valor anterior si falla
        }
    }

    // Manejar el cambio en los checkboxes de Declaraciones y Pagos
    async function handleCheckboxChange(event) {
        const checkbox = event.target;
        const mes = checkbox.dataset.mes;
        const tipo = checkbox.dataset.tipo; // 'declaracion' o 'pago'
        const estado = checkbox.checked; // true o false

        if (!clienteActualId || !mes || !tipo) return;

        try {
            // Enviar la actualización al Apps Script
            const result = await enviarDatosAppsScript('updateStatus', {
                clientId: clienteActualId,
                year: añoSeleccionado,
                month: mes,
                type: tipo, // 'declaracion' o 'pago'
                status: estado
            });

             if (result.status === 'success') {
                 mostrarMensaje(`${tipo === 'declaracion' ? 'Declaración' : 'Pago'} de ${mes} actualizado.`, 'success');
                 // Opcional: Actualizar resumen en la pestaña de inicio si es necesario
                  if (document.getElementById('inicio').classList.contains('active')) {
                      actualizarResumenInicio();
                  }
             } else {
                  mostrarMensaje(`Fallo al actualizar estado de ${tipo}: ${result.message}`, 'error');
                 // Opcional: Revertir el estado del checkbox si falla
                  checkbox.checked = !estado;
             }

        } catch (error) {
             mostrarMensaje(`Error al guardar estado de ${tipo}: ${error.message}`, 'error');
             // Opcional: Revertir el estado del checkbox si falla
             checkbox.checked = !estado;
        }
    }


    function cerrarDetalleCliente() {
        clienteActualId = null; // Limpiar el cliente actual
        mostrarVista('main'); // Volver a la vista principal
        // Opcional: Volver a la pestaña de clientes
         openTab(null, 'clientes');
    }

    // --- Funcionalidad de Edición de Cliente (Modal) ---

    let clienteEditando = null; // Para saber qué cliente se está editando en el modal

    async function abrirModalEditarCliente() {
        if (!clienteActualId) return;

        // Buscar el cliente en el array local
        clienteEditando = clientes.find(c => c.id === clienteActualId);
        if (!clienteEditando) {
            mostrarMensaje('Cliente no encontrado para editar.', 'error');
            return;
        }

        // Llenar el modal con los datos actuales del cliente
        document.getElementById('edit-nombre-cliente').value = clienteEditando.nombre;
        document.getElementById('edit-rfc-cliente').value = clienteEditando.rfc;

        // Mostrar el modal
        document.getElementById('modalEditarCliente').style.display = 'flex'; // Usar flex para centrar
    }

    function cerrarModalEditarCliente() {
        document.getElementById('modalEditarCliente').style.display = 'none';
        clienteEditando = null; // Limpiar el cliente en edición
    }

    async function guardarEdicionCliente() {
        if (!clienteEditando) return;

        const nuevoNombre = document.getElementById('edit-nombre-cliente').value.trim();
        const nuevoRfc = document.getElementById('edit-rfc-cliente').value.trim();

        if (nuevoNombre && nuevoRfc) {
            try {
                // Enviar la actualización al Apps Script
                const result = await enviarDatosAppsScript('updateClient', {
                    clientId: clienteEditando.id,
                    nombre: nuevoNombre,
                    rfc: nuevoRfc
                });

                if (result.status === 'success') {
                    mostrarMensaje('Cliente actualizado con éxito.', 'success');
                    // Actualizar el cliente en el array local
                    clienteEditando.nombre = nuevoNombre;
                    clienteEditando.rfc = nuevoRfc;
                    // Actualizar la UI de detalle
                    document.getElementById('nombre-cliente-detalle').textContent = nuevoNombre;
                    document.getElementById('rfc-cliente-detalle').textContent = nuevoRfc;
                    cerrarModalEditarCliente();
                    await listarClientes(); // Volver a cargar la lista principal para reflejar el cambio
                } else {
                     mostrarMensaje(`Fallo al actualizar cliente: ${result.message}`, 'error');
                }

            } catch (error) {
                 mostrarMensaje(`Error al guardar edición del cliente: ${error.message}`, 'error');
            }
        } else {
            mostrarMensaje('El nombre y RFC no pueden estar vacíos.', 'warning');
        }
    }

    // Cerrar modal haciendo clic fuera de él
    window.onclick = function(event) {
        const modal = document.getElementById('modalEditarCliente');
        if (event.target === modal) {
            cerrarModalEditarCliente();
        }
    }


    // --- Funcionalidad de Resumen en Inicio ---

    async function actualizarResumenInicio() {
        const listaPendientesUl = document.getElementById('lista-pendientes');
        const listaPagosUl = document.getElementById('lista-pagos');

        listaPendientesUl.innerHTML = ''; // Limpiar listas
        listaPagosUl.innerHTML = '';

        try {
            // Obtener el resumen de pendientes desde el Apps Script
            const resumenPendientes = await obtenerDatosAppsScript('getPendingSummary');

            if (resumenPendientes.declaraciones.length === 0) {
                 listaPendientesUl.innerHTML = '<li>No hay declaraciones pendientes.</li>';
            } else {
                resumenPendientes.declaraciones.forEach(item => {
                    // Asume que item tiene propiedades como clienteNombre, mes, año
                     listaPendientesUl.innerHTML += `<li>${item.clienteNombre} - Declaración ${item.mes} ${item.año}</li>`;
                });
            }

             if (resumenPendientes.pagos.length === 0) {
                 listaPagosUl.innerHTML = '<li>No hay pagos pendientes.</li>';
            } else {
                resumenPendientes.pagos.forEach(item => {
                    // Asume que item tiene propiedades como clienteNombre, mes, año
                     listaPagosUl.innerHTML += `<li>${item.clienteNombre} - Pago ${item.mes} ${item.año}</li>`;
                });
            }

        } catch (error) {
            // El error ya se maneja en obtenerDatosAppsScript
             listaPendientesUl.innerHTML = '<li>Error al cargar declaraciones pendientes.</li>';
             listaPagosUl.innerHTML = '<li>Error al cargar pagos pendientes.</li>';
        }
    }


    // --- Funcionalidad de Gráficos ---

    // Carga los clientes en el selector de la pestaña de gráficos
    async function cargarClientesEnSelectorGraficos() {
         const clienteSelector = document.getElementById('cliente-selector-graficos');
         clienteSelector.innerHTML = '<option value="">-- Selecciona un cliente --</option>'; // Opción por defecto

         try {
             // Obtener la lista de clientes (si no está ya cargada)
             if (clientes.length === 0) {
                  const clientesData = await obtenerDatosAppsScript('getClients');
                  clientes = clientesData; // Actualizar el array local
             }


             clientes.forEach(cliente => {
                 const option = document.createElement('option');
                 option.value = cliente.id; // Usar el ID del cliente
                 option.textContent = cliente.nombre;
                 clienteSelector.appendChild(option);
             });

         } catch (error) {
             // El error ya se maneja en obtenerDatosAppsScript
             mostrarMensaje('Error al cargar clientes para gráficos.', 'error');
         }
    }

    // Muestra los gráficos para el cliente seleccionado
    async function mostrarGraficosCliente() {
        const clienteSelector = document.getElementById('cliente-selector-graficos');
        const clienteId = clienteSelector.value;
        const graficosArea = document.getElementById('graficos-area');
        const noClienteSelected = document.getElementById('no-cliente-selected');
        const mensajePersonalizado = document.getElementById('mensaje-personalizado-graficos');

        // Destruir gráficos existentes si los hay
        if (graficoAnualChart) {
            graficoAnualChart.destroy();
            graficoAnualChart = null;
        }
         if (graficoMensualPieChart) {
             graficoMensualPieChart.destroy();
             graficoMensualPieChart = null;
         }


        if (!clienteId) {
            graficosArea.style.display = 'none';
            noClienteSelected.style.display = 'block';
            mensajePersonalizado.textContent = '';
            return;
        }

        // Buscar el cliente en el array local
        const cliente = clientes.find(c => c.id == clienteId); // Usar == para comparar string/number si es necesario
        if (!cliente) {
             mostrarMensaje('Cliente no encontrado para gráficos.', 'error');
             graficosArea.style.display = 'none';
             noClienteSelected.style.display = 'block';
             mensajePersonalizado.textContent = '';
             return;
        }

        // Cargar selectores de mes y año para la gráfica mensual
         cargarSelectoresMesAñoGraficos();


        // Mostrar el área de gráficos y ocultar el mensaje de "selecciona cliente"
        noClienteSelected.style.display = 'none';
        graficosArea.style.display = 'block';
        mensajePersonalizado.textContent = `Gráficos para ${cliente.nombre}`;


        try {
            // Obtener todos los datos anuales del cliente para la gráfica de evolución
            const datosAnualesEvolucion = await obtenerDatosAppsScript('getClientAnnualEvolution', {
                clientId: clienteId
            });

            // Asume que datosAnualesEvolucion es un objeto con arrays: { meses: [], ingresos: [], gastos: [], impuestos: [] }
            const etiquetasMeses = datosAnualesEvolucion.meses || meses; // Usar meses por defecto si no vienen
            const ingresosData = datosAnualesEvolucion.ingresos || Array(12).fill(0);
            const gastosData = datosAnualesEvolucion.gastos || Array(12).fill(0);
            const impuestosData = datosAnualesEvolucion.impuestos || Array(12).fill(0);


            // Crear Gráfico Anual (Evolución Mensual)
            const ctxAnual = document.getElementById('graficoAnual').getContext('2d');
            graficoAnualChart = new Chart(ctxAnual, {
                type: 'line',
                data: {
                    labels: etiquetasMeses, // Enero a Diciembre
                    datasets: [{
                        label: 'Ingresos',
                        data: ingresosData, // Datos de ingresos por mes
                        borderColor: '#4CAF50', // Verde
                        tension: 0.1,
                        fill: false
                    }, {
                        label: 'Gastos',
                        data: gastosData, // Datos de gastos por mes
                        borderColor: '#F44336', // Rojo
                        tension: 0.1,
                        fill: false
                    }, {
                        label: 'Impuestos',
                        data: impuestosData, // Datos de impuestos por mes
                        borderColor: '#2196F3', // Azul
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // Permitir que el contenedor controle el tamaño
                     plugins: {
                         legend: {
                             labels: {
                                 color: '#ccc' // Color de la leyenda
                             }
                         }
                     },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Mes',
                                color: '#ccc'
                            },
                             ticks: {
                                 color: '#eee' // Color de las etiquetas del eje X
                             },
                             grid: {
                                 color: 'rgba(255,255,255,0.1)' // Color de las líneas de la cuadrícula
                             }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Monto ($)',
                                color: '#ccc'
                            },
                             ticks: {
                                 color: '#eee' // Color de las etiquetas del eje Y
                             },
                             grid: {
                                 color: 'rgba(255,255,255,0.1)' // Color de las líneas de la cuadrícula
                             }
                        }
                    }
                }
            });

            // Inicializar la gráfica de pastel con el mes y año seleccionados por defecto
             updateMonthlyPieChart();


        } catch (error) {
             // El error ya se maneja en obtenerDatosAppsScript
             mensajePersonalizado.textContent = `Error al cargar gráficos para ${cliente.nombre}.`;
             graficosArea.style.display = 'block'; // Mostrar el área para mostrar el mensaje de error
             noClienteSelected.style.display = 'none';
        }
    }

    // Carga los selectores de mes y año para la gráfica de pastel
    function cargarSelectoresMesAñoGraficos() {
        const monthSelector = document.getElementById('month-selector-pie');
        const yearSelector = document.getElementById('year-selector-pie');

        // Limpiar selectores
        monthSelector.innerHTML = '';
        yearSelector.innerHTML = '';

        // Llenar selector de meses (siempre los 12 meses)
        meses.forEach(mes => {
            const option = document.createElement('option');
            option.value = mes;
            option.textContent = mes;
            monthSelector.appendChild(option);
        });

        // Llenar selector de años (añadir años desde el año actual - 5 hasta el año actual + 1, por ejemplo)
        const startYear = añoActual - 5;
        const endYear = añoActual + 1;
        for (let year = startYear; year <= endYear; year++) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            yearSelector.appendChild(option);
        }

        // Seleccionar el mes y año actual por defecto
        monthSelector.value = meses[new Date().getMonth()]; // Mes actual
        yearSelector.value = añoActual;
    }


    // Actualiza la gráfica de pastel mensual
    async function updateMonthlyPieChart() {
        const clienteSelector = document.getElementById('cliente-selector-graficos');
        const clienteId = clienteSelector.value;
        const monthSelector = document.getElementById('month-selector-pie');
        const yearSelector = document.getElementById('year-selector-pie');
        const legendDiv = document.getElementById('pie-chart-legend');

        if (!clienteId) return; // No hacer nada si no hay cliente seleccionado

        const selectedMonth = monthSelector.value;
        const selectedYear = parseInt(yearSelector.value);

        // Destruir gráfico de pastel existente si lo hay
        if (graficoMensualPieChart) {
            graficoMensualPieChart.destroy();
            graficoMensualPieChart = null;
        }
        legendDiv.innerHTML = ''; // Limpiar leyenda

        try {
            // Obtener los datos del mes y año seleccionados para la gráfica de pastel
            const datosMensuales = await obtenerDatosAppsScript('getClientMonthlyData', {
                clientId: clienteId,
                year: selectedYear,
                month: selectedMonth
            });

            // Asume que datosMensuales es un objeto: { ingresos: N, gastos: N, impuestos: N }
            const ingresos = datosMensuales.ingresos || 0;
            const gastos = datosMensuales.gastos || 0;
            const impuestos = datosMensuales.impuestos || 0;

            const data = {
                labels: ['Ingresos', 'Gastos', 'Impuestos'],
                datasets: [{
                    data: [ingresos, gastos, impuestos],
                    backgroundColor: [
                        '#4CAF50', // Verde
                        '#F44336', // Rojo
                        '#2196F3'  // Azul
                    ],
                    borderColor: '#333', // Borde oscuro
                    borderWidth: 1
                }]
            };

             // Crear Gráfico Mensual (Pastel)
            const ctxMensual = document.getElementById('graficoMensualPie').getContext('2d');
            graficoMensualPieChart = new Chart(ctxMensual, {
                type: 'pie',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false // Ocultar la leyenda por defecto de Chart.js
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(context.parsed);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });

            // Generar leyenda personalizada
             const backgroundColors = graficoMensualPieChart.data.datasets[0].backgroundColor;
             data.labels.forEach((label, index) => {
                 const legendItem = document.createElement('div');
                 legendItem.classList.add('pie-chart-legend-item');
                 legendItem.innerHTML = `
                     <span class="pie-chart-legend-color" style="background-color: ${backgroundColors[index]}"></span>
                     ${label}: ${new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(data.datasets[0].data[index])}
                 `;
                 legendDiv.appendChild(legendItem);
             });


        } catch (error) {
             // El error ya se maneja en obtenerDatosAppsScript
             legendDiv.innerHTML = '<p class="text-red-500">Error al cargar datos del mes.</p>';
        }
    }


    // --- Inicialización ---

    // Cargar datos y mostrar la pestaña de inicio al cargar la página
    document.addEventListener('DOMContentLoaded', async () => {
        // Al cargar la página, intentar listar clientes para poblar el array 'clientes'
        // Esto también se llama cuando se cambia a la pestaña 'clientes'
        // await listarClientes(); // No es necesario llamar aquí, se llama al abrir la pestaña 'clientes'

        // Mostrar la pestaña de inicio por defecto
        openTab(null, 'inicio'); // Pasar null para el evento y 'inicio' como tabId
    });

</script>

</body>
</html>
